import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import {
  getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc,
  where, getDocs
} from 'firebase/firestore';
import { v4 as uuidv4 } from 'uuid'; // For generating unique IDs for new contacts

// --- JONI Integration Constants (PLACEHOLDER) ---
// Note: In a real-world scenario, JONI API calls would happen from the Google Apps Script
// or a secure backend, not directly from the client-side React app for security.
// This is a placeholder for demonstration purposes.
const JONI_SEND_API_URL = "YOUR_JONI_SEND_API_ENDPOINT_HERE";
const JONI_API_KEY = "YOUR_JONI_API_KEY_HERE";

// --- Google Drive & Office 365 Placeholders (Client-Side Simulation) ---
// In a real-world scenario, these would involve server-side authentication and API calls.
const uploadToGoogleDrive = async (file, contactId) => {
  console.log(`Simulating upload of file ${file.name} to Google Drive for contact ${contactId}`);
  // Actual API call would involve Google Drive API, e.g., via Google Apps Script or a backend
  return new Promise(resolve => setTimeout(() => resolve(`https://drive.google.com/file/${uuidv4()}`), 1500));
};

const createOffice365Meeting = async (details) => {
  console.log("Simulating Office 365 meeting creation:", details);
  // Actual API call would involve Office 365 Graph API
  return new Promise(resolve => setTimeout(() => resolve(`https://outlook.office.com/calendar/meeting/${uuidv4()}`), 1500));
};

const App = () => {
  const [messages, setMessages] = useState([]);
  const [inputMessage, setInputMessage] = useState('');
  const [currentChatId, setCurrentChatId] = useState(null);
  const [chatSummaries, setChatSummaries] = useState([]);
  const [contacts, setContacts] = useState([]); // All contacts for the "Contacts" tab
  const [selectedFile, setSelectedFile] = useState(null);
  const [myContactName, setMyContactName] = useState('×¨×××™ ××¡××¨×•×”'); // User's own name
  const [myProfilePic, setMyProfilePic] = useState('https://i.postimg.cc/2817JMT2/2025-08-24-044258.png'); // User's profile pic
  const [systemMessage, setSystemMessage] = useState('');
  const [loading, setLoading] = useState(false);
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [showOrderModal, setShowOrderModal] = useState(false);
  const [showReminderModal, setShowReminderModal] = useState(false);
  const [showContactDetailModal, setShowContactDetailModal] = useState(false); // For showing contact details
  const [showAddContactModal, setShowAddContactModal] = useState(false); // For adding new contact
  const [showUploadChatModal, setShowUploadChatModal] = useState(false); // For uploading chat to a new contact
  const [selectedContact, setSelectedContact] = useState(null); // The contact whose details are shown
  const [orderForm, setOrderForm] = useState({ customer: '', items: '', date: '', notes: '' });
  const [reminderForm, setReminderForm] = useState({ title: '', date: '', time: '', notes: '', contactId: null });
  const [newContactForm, setNewContactForm] = useState({ name: '', whatsappNumber: '', profilePic: '', email: '', address: '', socialMedia: '' });
  const [currentTab, setCurrentTab] = useState('chats'); // 'chats' or 'contacts'
  const [userId, setUserId] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const messagesEndRef = useRef(null);
  const chatInputRef = useRef(null); // Ref for the chat input field for paste event
  const [contactSearchTerm, setContactSearchTerm] = useState(''); // For contact search

  const highlightRules = [
    { regex: /(×”×–×× ×” ×—×“×©×”|×“×—×•×£|×˜×™×¤×•×œ|×œ× ×˜×•×¤×œ|×¦×¨×™×š ×œ×‘×“×•×§)/g, className: 'bg-yellow-200 font-bold' },
    { regex: /(×ª×–×›×•×¨×ª|×™×•××Ÿ|××—×¨|×”×™×•×)/g, className: 'bg-blue-200 font-bold' },
    { regex: /(×‘×¢×™×”|×ª×§×œ×”|×—×¡×¨)/g, className: 'bg-red-200 font-bold' },
  ];

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  // Firebase Initialization and Auth
  useEffect(() => {
    const appId = typeof __app_id !== "undefined" ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== "undefined" ? JSON.parse(__firebase_config) : {};

    if (Object.keys(firebaseConfig).length === 0) {
      console.error("Firebase config is missing or empty.");
      setSystemMessage("×©×’×™××”: ×”×’×“×¨×•×ª Firebase ×—×¡×¨×•×ª. ×× × ×•×“× ×©×”××¤×œ×™×§×¦×™×” ×”×•×’×“×¨×” ×›×”×œ×›×”.");
      return;
    }

    const app = initializeApp(firebaseConfig);
    const firestoreDb = getFirestore(app);
    const firebaseAuth = getAuth(app);

    setDb(firestoreDb);
    setAuth(firebaseAuth);

    const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        const initialAuthToken = typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;
        if (initialAuthToken) {
          try {
            await signInWithCustomToken(firebaseAuth, initialAuthToken);
          } catch (error) {
            console.error("Error signing in with custom token:", error);
            await signInAnonymously(firebaseAuth);
          }
        } else {
          await signInAnonymously(firebaseAuth);
        }
      }
      setIsAuthReady(true);
    });

    return () => unsubscribe();
  }, []);

  // Fetch chat summaries, contacts, and active chat messages once authenticated
  useEffect(() => {
    if (!isAuthReady || !db || !userId) return;

    // Fetch contacts
    const qContacts = query(collection(db, `artifacts/${__app_id}/users/${userId}/contacts`), orderBy('name'));
    const unsubscribeContacts = onSnapshot(qContacts, (snapshot) => {
      setContacts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (error) => {
      console.error("Error fetching contacts:", error);
      setSystemMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×× ×©×™ ×§×©×¨.");
    });

    // Fetch chat summaries
    const qChats = query(collection(db, `artifacts/${__app_id}/users/${userId}/chats`), orderBy('lastMessageTimestamp', 'desc'));
    const unsubscribeChats = onSnapshot(qChats, (snapshot) => {
      const summaries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setChatSummaries(summaries);
      if (!currentChatId && summaries.length > 0) {
        setCurrentChatId(summaries[0].id);
      }
    }, (error) => {
      console.error("Error fetching chat summaries:", error);
      setSystemMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×™×›×•××™ ×¦'××˜×™×.");
    });

    // Fetch messages for the currently selected chat
    let unsubscribeMessages = () => {};
    if (currentChatId) {
      const qMessages = query(collection(db, `artifacts/${__app_id}/users/${userId}/chats/${currentChatId}/messages`), orderBy('timestamp'));
      unsubscribeMessages = onSnapshot(qMessages, (snapshot) => {
        const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setMessages(msgs);
        scrollToBottom();
      }, (error) => {
        console.error("Error fetching messages:", error);
        setSystemMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×•×“×¢×•×ª ×¦'××˜.");
      });
    }

    return () => {
      unsubscribeContacts();
      unsubscribeChats();
      unsubscribeMessages();
    };
  }, [isAuthReady, db, userId, currentChatId]);

  // Handle file upload (WhatsApp .txt backup or .vcf)
  const handleFileSelect = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setSelectedFile(file);
    setLoading(true);
    setSystemMessage('××¢×‘×“ ×§×•×‘×¥ ×’×™×‘×•×™...');

    try {
      const fileContent = await file.text();
      if (file.name.endsWith('.txt')) {
        await processWhatsAppChatFile(fileContent, file.name);
      } else if (file.name.endsWith('.vcf')) {
        await processVCardFile(fileContent);
      } else {
        setSystemMessage('×¤×•×¨××˜ ×§×•×‘×¥ ×œ× × ×ª××š. ×× × ×”×¢×œ×” ×§×•×‘×¥ .txt ××• .vcf.');
      }
    } catch (error) {
      console.error("Error processing file:", error);
      setSystemMessage(`×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥: ${error.message}`);
    } finally {
      setLoading(false);
      setSelectedFile(null);
    }
  };

  const processWhatsAppChatFile = async (fileContent, fileName) => {
    const parsedMessages = parseWhatsAppChat(fileContent);

    if (parsedMessages.length === 0) {
      setSystemMessage('×œ× × ××¦××• ×”×•×“×¢×•×ª ×‘×§×•×‘×¥ ×”×’×™×‘×•×™. ×•×“× ×©×”×¤×•×¨××˜ × ×›×•×Ÿ.');
      return;
    }

    // Determine chat name from the filename or message senders
    let chatName = fileName.replace(".txt", "").replace("â€×¦'××˜ WhatsApp ×¢× â€â€ª", "").replace("â€¬â€", "");
    const phoneRegex = /\+?\d{9,15}/; // Basic phone number regex
    const phoneMatch = chatName.match(phoneRegex);

    if (phoneMatch) {
      chatName = chatName.replace(phoneMatch[0], "").trim(); // Remove phone number from chat name
    }

    // Attempt to find a contact or create a new one based on chatName and phone number
    let contactDoc = contacts.find(c => c.name === chatName || c.whatsappNumber === phoneMatch?.[0]);
    let contactId;

    if (!contactDoc) {
      // Create a new contact
      const newContactData = {
        name: chatName,
        whatsappNumber: phoneMatch ? phoneMatch[0] : "",
        profilePic: `https://placehold.co/100x100/F0F2F5/A3A9B2?text=${chatName.charAt(0)}`, // Placeholder
        createdAt: serverTimestamp(),
      };
      const newContactRef = await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/contacts`), newContactData);
      contactId = newContactRef.id;
      contactDoc = { id: contactId, ...newContactData };
    } else {
      contactId = contactDoc.id;
    }

    // Create or update chat summary
    let chatRef;
    const existingChatQuery = query(collection(db, `artifacts/${__app_id}/users/${userId}/chats`), where('contactId', "==", contactId));
    const existingChatSnapshot = await getDocs(existingChatQuery);

    if (!existingChatSnapshot.empty) {
      chatRef = existingChatSnapshot.docs[0].ref;
      await updateDoc(chatRef, {
        lastMessageTimestamp: parsedMessages[parsedMessages.length - 1].timestamp,
        summary: parsedMessages[parsedMessages.length - 1].message,
        contactName: contactDoc.name,
      });
    } else {
      chatRef = await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/chats`), {
        name: contactDoc.name,
        contactId: contactId,
        lastMessageTimestamp: parsedMessages[parsedMessages.length - 1].timestamp,
        summary: parsedMessages[parsedMessages.length - 1].message,
        createdAt: serverTimestamp(),
      });
    }
    setCurrentChatId(chatRef.id);

    // Add messages to the subcollection
    const messagesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/chats/${chatRef.id}/messages`);
    for (const msg of parsedMessages) {
      await addDoc(messagesCollectionRef, {
        sender: msg.sender,
        message: msg.message,
        timestamp: msg.timestamp,
        originalTimestamp: msg.originalTimestamp
      });
    }
    setSystemMessage("×§×•×‘×¥ ×’×™×‘×•×™ ×¦'××˜ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×”×”×•×“×¢×•×ª × ×©××¨×• ×‘-Firestore.");
  };

  const processVCardFile = async (fileContent) => {
    const vcfs = fileContent.split('END:VCARD').filter(block => block.trim() !== '').map(block => block + 'END:VCARD');

    for (const vcf of vcfs) {
      const nameMatch = vcf.match(/FN:(.*)/);
      const telMatch = vcf.match(/TEL;waid=(\+?\d+):(\+?\d+)/) || vcf.match(/TEL;type=CELL;type=VOICE:(\+?\d+)/);
      const photoMatch = vcf.match(/PHOTO;BASE64:(.*)/s); // 's' flag for dotall

      const name = nameMatch ? nameMatch[1].trim() : '×©× ×œ× ×™×“×•×¢';
      const whatsappNumber = telMatch ? (telMatch[1] || telMatch[2]).trim() : '';
      const profilePicBase64 = photoMatch ? photoMatch[1].trim() : '';

      let profilePicUrl = `https://placehold.co/100x100/F0F2F5/A3A9B2?text=${name.charAt(0)}`;
      if (profilePicBase64) {
        // In a real app, you'd upload this to a storage service (like Google Cloud Storage) and get a URL.
        // For this demo, we'll indicate it was found.
        profilePicUrl = 'Base64 image found (needs upload to storage)';
        console.log(`Base64 image for ${name} found. In a real app, this would be uploaded.`);
      }

      const existingContact = contacts.find(c => (c.whatsappNumber && c.whatsappNumber === whatsappNumber) || c.name === name);

      if (existingContact) {
        await updateDoc(doc(db, `artifacts/${__app_id}/users/${userId}/contacts`, existingContact.id), {
          name: name,
          whatsappNumber: whatsappNumber,
          profilePic: profilePicUrl,
        });
      } else {
        await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/contacts`), {
          name: name,
          whatsappNumber: whatsappNumber,
          profilePic: profilePicUrl,
          createdAt: serverTimestamp(),
        });
      }
    }
    setSystemMessage('×§×•×‘×¥ ×× ×©×™ ×§×©×¨ (.vcf) × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×× ×©×™ ×”×§×©×¨ × ×©××¨×•/×¢×•×“×›× ×• ×‘-Firestore.');
  };

  // Parse WhatsApp .txt chat backup
  const parseWhatsAppChat = (chatContent) => {
    const messages = [];
    const lines = chatContent.split('\n');
    const regex = /^\[(\d{1,2}\/\d{1,2}\/\d{4}), (\d{1,2}:\d{2}:\d{2} [××‘"×¦×œ×”"× ]{1,3})\] (.*?): (.*)/; // Updated regex for Hebrew AM/PM, handling more variations

    let currentMessage = null;

    for (const line of lines) {
      const match = line.match(regex);
      if (match) {
        if (currentMessage) {
          messages.push(currentMessage);
        }
        const [, dateStr, timeStr, sender, message] = match;
        const formattedDate = formatHebrewDateTime(`${dateStr} ${timeStr}`);
        currentMessage = {
          sender: sender.trim(),
          message: message.trim(),
          timestamp: formattedDate,
          originalTimestamp: `${dateStr} ${timeStr}`
        };
      } else if (currentMessage) {
        currentMessage.message += '\n' + line.trim();
      }
    }
    if (currentMessage) {
      messages.push(currentMessage);
    }
    return messages;
  };

  const formatHebrewDateTime = (hebrewDateTime) => {
    let [datePart, timePart] = hebrewDateTime.split(', ');
    const [day, month, year] = datePart.split('/').map(Number);
    let [time, ampm] = timePart.split(' ');

    let [hours, minutes, seconds] = time.split(':').map(Number);

    if (ampm) {
        if (ampm.includes('×œ×¤× ×•×ª ×‘×•×§×¨') && hours === 12) { hours = 0; } // 12 AM is midnight
        else if (ampm.includes('×¦×”×¨×™×™×') && hours < 12) { hours += 12; } // 1-11 PM
        else if (ampm.includes('××—×¨ ×”×¦×”×¨×™×™×') && hours < 12) { hours += 12; }
        else if (ampm.includes('×¢×¨×‘') && hours < 12) { hours += 12; }
        else if (ampm.includes('×œ×™×œ×”') && hours < 12) { hours += 12; } // Handle cases like 1 AM (1 ×‘×œ×™×œ×”)
    }

    return new Date(year, month - 1, day, hours, minutes, seconds || 0);
  };

  const handleSendMessage = async () => {
    if (!inputMessage.trim() || !currentChatId || !db || !userId) return;

    setLoading(true);
    try {
      const newMessage = {
        sender: myContactName,
        message: inputMessage.trim(),
        timestamp: new Date(),
      };

      const messagesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/chats/${currentChatId}/messages`);
      await addDoc(messagesCollectionRef, newMessage);

      const chatRef = doc(db, `artifacts/${__app_id}/users/${userId}/chats/${currentChatId}`);
      await updateDoc(chatRef, {
        lastMessageTimestamp: newMessage.timestamp,
        summary: newMessage.message,
      });

      setInputMessage('');
      setSystemMessage('×”×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×•× ×©××¨×” ×‘-Firestore.');

      if (JONI_SEND_API_URL !== "YOUR_JONI_SEND_API_ENDPOINT_HERE") {
        console.log("Simulating sending message via JONI:", newMessage);
      }

    } catch (error) {
      console.error("Error sending message:", error);
      setSystemMessage(`×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const openOrderModal = useCallback(() => {
    setShowOrderModal(true);
    if (currentChatId) {
      const selectedChat = chatSummaries.find(chat => chat.id === currentChatId);
      const contact = contacts.find(c => c.id === selectedChat?.contactId);
      if (contact && !contact.name.startsWith('×§×‘×•×¦×”:')) {
        setOrderForm(prev => ({ ...prev, customer: contact.name }));
      }
    }
  }, [currentChatId, chatSummaries, contacts]);

  const handleOrderSubmit = async () => {
    if (!orderForm.customer || !orderForm.items || !db || !userId) {
      setSystemMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×” ×‘×”×–×× ×”.');
      return;
    }

    setLoading(true);
    try {
      const contact = contacts.find(c => c.name === orderForm.customer);
      let orderChatId = currentChatId;

      if (!orderChatId && contact) {
          // If no chat is selected but a contact exists, find or create a chat for them
          const existingChatQuery = query(collection(db, `artifacts/${__app_id}/users/${userId}/chats`), where('contactId', "==", contact.id));
          const existingChatSnapshot = await getDocs(existingChatQuery);
          if (!existingChatSnapshot.empty) {
              orderChatId = existingChatSnapshot.docs[0].id;
          } else {
              const newChatRef = await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/chats`), {
                  name: contact.name,
                  contactId: contact.id,
                  lastMessageTimestamp: new Date(),
                  summary: '×”×–×× ×” × ×•×¦×¨×”',
                  createdAt: serverTimestamp(),
              });
              orderChatId = newChatRef.id;
              setCurrentChatId(orderChatId); // Make this the current chat
          }
      } else if (!orderChatId && !contact) {
          setSystemMessage('×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×”×–×× ×” ×œ×œ× ×¦"××˜ × ×‘×—×¨ ××• ×œ×§×•×— ×§×™×™×.');
          setLoading(false);
          return;
      }

      await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/orders`), {
        chatId: orderChatId,
        customer: orderForm.customer,
        items: orderForm.items,
        date: orderForm.date ? new Date(orderForm.date) : serverTimestamp(),
        notes: orderForm.notes,
        status: '×—×“×©',
        createdAt: serverTimestamp(),
      });

      const orderMessage = `ğŸ“¦ ×”×–×× ×” ×—×“×©×” ×¢×‘×•×¨ ${orderForm.customer}:\n×¤×¨×™×˜×™×: ${orderForm.items}\n×ª××¨×™×š: ${orderForm.date || '×œ× ×¦×•×™×Ÿ'}\n×”×¢×¨×•×ª: ${orderForm.notes || '××™×Ÿ'}`;
      const newMessage = {
        sender: myContactName,
        message: orderMessage,
        timestamp: new Date(),
      };
      const messagesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/chats/${orderChatId}/messages`);
      await addDoc(messagesCollectionRef, newMessage);

      const chatRef = doc(db, `artifacts/${__app_id}/users/${userId}/chats/${orderChatId}`);
      await updateDoc(chatRef, {
        lastMessageTimestamp: newMessage.timestamp,
        summary: newMessage.message,
      });

      setOrderForm({ customer: '', items: '', date: '', notes: '' });
      setShowOrderModal(false);
      setSystemMessage('×”×–×× ×” × ×•×¦×¨×” ×•× ×©××¨×” ×‘×”×¦×œ×—×”!');
    } catch (error) {
      console.error("Error creating order:", error);
      setSystemMessage(`×©×’×™××” ×‘×™×¦×™×¨×ª ×”×–×× ×”: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const openReminderModal = useCallback((contactId = null) => {
    setShowReminderModal(true);
    setReminderForm(prev => ({ ...prev, contactId: contactId }));
    if (contactId) {
      const contact = contacts.find(c => c.id === contactId);
      setReminderForm(prev => ({ ...prev, title: `×ª×–×›×•×¨×ª ×¢×‘×•×¨ ${contact?.name || ''}` }));
    }
  }, [contacts]);

  const handleReminderSubmit = async () => {
    if (!reminderForm.title || !reminderForm.date || !reminderForm.time || !db || !userId) {
      setSystemMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×” ×‘×ª×–×›×•×¨×ª.');
      return;
    }

    setLoading(true);
    try {
      const reminderDateTime = new Date(`${reminderForm.date}T${reminderForm.time}`);
      await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/reminders`), {
        title: reminderForm.title,
        dateTime: reminderDateTime,
        notes: reminderForm.notes,
        contactId: reminderForm.contactId,
        status: '×¤×¢×™×œ',
        createdAt: serverTimestamp(),
      });

      if (currentChatId) {
        const reminderMessage = `ğŸ”” ×ª×–×›×•×¨×ª ×—×“×©×”: ${reminderForm.title}\n××•×¢×“: ${new Date(reminderDateTime).toLocaleString('he-IL')}\n×”×¢×¨×•×ª: ${reminderForm.notes || '××™×Ÿ'}`;
        const newMessage = {
          sender: myContactName,
          message: reminderMessage,
          timestamp: new Date(),
        };
        const messagesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/chats/${currentChatId}/messages`);
        await addDoc(messagesCollectionRef, newMessage);

        const chatRef = doc(db, `artifacts/${__app_id}/users/${userId}/chats/${currentChatId}`);
        await updateDoc(chatRef, {
          lastMessageTimestamp: newMessage.timestamp,
          summary: newMessage.message,
        });
      }

      setReminderForm({ title: '', date: '', time: '', notes: '', contactId: null });
      setShowReminderModal(false);
      setSystemMessage('×ª×–×›×•×¨×ª × ×•×¦×¨×” ×•× ×©××¨×” ×‘×”×¦×œ×—×”!');
    } catch (error) {
      console.error("Error creating reminder:", error);
      setSystemMessage(`×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×–×›×•×¨×ª: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const applyHighlighting = (text) => {
    let highlightedText = text;
    highlightRules.forEach(rule => {
      highlightedText = highlightedText.replace(rule.regex, (match) => `<span class="${rule.className}">${match}</span>`);
    });
    return <span dangerouslySetInnerHTML={{ __html: highlightedText }} />;
  };

  const currentChatName = chatSummaries.find(chat => chat.id === currentChatId)?.name || '×‘×—×¨ ×¦"××˜';
  const currentChatContact = chatSummaries.find(chat => chat.id === currentChatId);
  const currentContactProfilePic = contacts.find(c => c.id === currentChatContact?.contactId)?.profilePic || 'https://placehold.co/100x100/A3A9B2/FFFFFF?text=P';

  const handleContactClick = (contact) => {
    setSelectedContact(contact);
    setShowContactDetailModal(true);
    // Find or create a chat for this contact
    const existingChat = chatSummaries.find(chat => chat.contactId === contact.id);
    if (existingChat) {
      setCurrentChatId(existingChat.id);
    } else {
      // Option to create a new chat when viewing contact details
      // For now, keep currentChatId as is until user explicitly starts a new chat from here
    }
  };

  const handleCreateNewContact = async () => {
    if (!newContactForm.name.trim() || !db || !userId) {
      setSystemMessage('×× × ×”×–×Ÿ ×©× ×¢×‘×•×¨ ××™×© ×”×§×©×¨ ×”×—×“×©.');
      return;
    }
    setLoading(true);
    try {
      const contactData = {
        name: newContactForm.name.trim(),
        whatsappNumber: newContactForm.whatsappNumber.trim(),
        profilePic: newContactForm.profilePic.trim() || `https://placehold.co/100x100/F0F2F5/A3A9B2?text=${newContactForm.name.charAt(0)}`,
        email: newContactForm.email.trim(),
        address: newContactForm.address.trim(),
        socialMedia: newContactForm.socialMedia.trim(),
        createdAt: serverTimestamp(),
      };
      await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/contacts`), contactData);
      setNewContactForm({ name: '', whatsappNumber: '', profilePic: '', email: '', address: '', socialMedia: '' });
      setShowAddContactModal(false);
      setSystemMessage('××™×© ×§×©×¨ ×—×“×© × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
    } catch (error) {
      console.error("Error creating new contact:", error);
      setSystemMessage(`×©×’×™××” ×‘×™×¦×™×¨×ª ××™×© ×§×©×¨: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const handleUploadChatForNewContact = async (fileContent) => {
    if (!selectedContact || !db || !userId) {
      setSystemMessage('×™×© ×œ×‘×—×•×¨ ××™×© ×§×©×¨ ×œ×¤× ×™ ×”×¢×œ××ª ×¦"××˜.');
      return;
    }
    setLoading(true);
    try {
      const parsedMessages = parseWhatsAppChat(fileContent);
      if (parsedMessages.length === 0) {
        setSystemMessage('×œ× × ××¦××• ×”×•×“×¢×•×ª ×‘×§×•×‘×¥ ×”×’×™×‘×•×™. ×•×“× ×©×”×¤×•×¨××˜ × ×›×•×Ÿ.');
        setLoading(false);
        return;
      }

      // Create a new chat for this contact
      const chatRef = await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/chats`), {
        name: selectedContact.name,
        contactId: selectedContact.id,
        lastMessageTimestamp: parsedMessages[parsedMessages.length - 1].timestamp,
        summary: parsedMessages[parsedMessages.length - 1].message,
        createdAt: serverTimestamp(),
      });
      setCurrentChatId(chatRef.id);

      const messagesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/chats/${chatRef.id}/messages`);
      for (const msg of parsedMessages) {
        await addDoc(messagesCollectionRef, {
          sender: msg.sender,
          message: msg.message,
          timestamp: msg.timestamp,
          originalTimestamp: msg.originalTimestamp
        });
      }
      setShowUploadChatModal(false);
      setSystemMessage('×§×•×‘×¥ ×’×™×‘×•×™ ×¦"××˜ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×” ×œ××™×© ×”×§×©×¨!');
    } catch (error) {
      console.error("Error uploading chat for new contact:", error);
      setSystemMessage(`×©×’×™××” ×‘×”×¢×œ××ª ×¦"××˜: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const handlePaste = useCallback(async (event) => {
    if (currentTab !== 'chats' || !currentChatId) return;

    const pastedText = event.clipboardData.getData('text');
    if (pastedText) {
      // Simulate processing pasted text as a new message from the other person
      setLoading(true);
      try {
        const newMessage = {
          sender: currentChatName, // Assume pasted text is from the other person in the chat
          message: pastedText,
          timestamp: new Date(),
        };
        const messagesCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/chats/${currentChatId}/messages`);
        await addDoc(messagesCollectionRef, newMessage);

        const chatRef = doc(db, `artifacts/${__app_id}/users/${userId}/chats/${currentChatId}`);
        await updateDoc(chatRef, {
          lastMessageTimestamp: newMessage.timestamp,
          summary: newMessage.message,
        });
        setSystemMessage('×”×•×“×¢×” ×©×”×•×“×‘×§×” × ×§×œ×˜×” ×‘×”×¦×œ×—×” ×•×©×•×™×›×” ×œ×¦"××˜.');
      } catch (error) {
        console.error("Error processing pasted text:", error);
        setSystemMessage(`×©×’×™××” ×‘×¢×™×‘×•×“ ×˜×§×¡×˜ ×©×”×•×“×‘×§: ${error.message}`);
      } finally {
        setLoading(false);
      }
    }
  }, [currentChatId, currentChatName, db, userId, currentTab]);

  useEffect(() => {
    const inputElement = chatInputRef.current;
    if (inputElement && currentTab === 'chats') {
      inputElement.addEventListener('paste', handlePaste);
    }
    return () => {
      if (inputElement) {
        inputElement.removeEventListener('paste', handlePaste);
      }
    };
  }, [handlePaste, currentTab]);

  const filteredContacts = contacts.filter(contact =>
    contact.name.toLowerCase().includes(contactSearchTerm.toLowerCase()) ||
    contact.whatsappNumber.includes(contactSearchTerm)
  );


  if (!isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="text-center text-gray-700">×˜×•×¢×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”...</div>
      </div>
    );
  }

  return (
    <div className="flex h-screen w-full font-sans text-right bg-gray-900" dir="rtl">
      {/* Sidebar for chat list or contacts list */}
      <div className={`transition-all duration-300 ${isSidebarOpen ? 'w-full md:w-1/3 lg:w-1/4' : 'w-0'} bg-gray-800 text-white flex-shrink-0 flex flex-col overflow-hidden rounded-lg shadow-xl m-2`}>
        <div className="p-4 bg-gray-900 flex justify-between items-center rounded-t-lg">
          <div className="flex items-center space-x-2 space-x-reverse">
            <img src={myProfilePic} alt="My Profile" className="w-10 h-10 rounded-full object-cover border-2 border-green-400" />
            <h2 className="text-xl font-bold">{myContactName}</h2>
          </div>
          <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>

        {/* Tab Navigation for Sidebar */}
        <div className="flex justify-around bg-gray-700 p-2 border-b border-gray-600">
          <button
            className={`flex-1 p-2 rounded-lg font-semibold ${currentTab === 'chats' ? 'bg-green-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-600'}`}
            onClick={() => setCurrentTab('chats')}
          >
            ×”×•×“×¢×•×ª
          </button>
          <button
            className={`flex-1 p-2 rounded-lg font-semibold ${currentTab === 'contacts' ? 'bg-green-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-600'}`}
            onClick={() => setCurrentTab('contacts')}
          >
            ×× ×©×™ ×§×©×¨
          </button>
        </div>

        {currentTab === 'chats' && (
          <>
            <div className="p-4 border-b border-gray-700">
              <label className="block text-sm font-medium text-gray-300 mb-2" htmlFor="whatsappFileInput">
                ×”×¢×œ×” ×’×™×‘×•×™ ×¦'××˜ (.txt) / ×× ×©×™ ×§×©×¨ (.vcf)
              </label>
              <input
                type="file"
                id="whatsappFileInput"
                accept=".txt,.vcf"
                onChange={handleFileSelect}
                className="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer"
                disabled={loading}
              />
            </div>
            <div className="flex-grow overflow-y-auto custom-scrollbar">
              {chatSummaries.map((chat) => (
                <div
                  key={chat.id}
                  className={`p-4 border-b border-gray-700 cursor-pointer hover:bg-gray-700 flex items-center space-x-3 space-x-reverse ${currentChatId === chat.id ? 'bg-gray-700' : ''}`}
                  onClick={() => setCurrentChatId(chat.id)}
                >
                  <img
                    src={contacts.find(c => c.id === chat.contactId)?.profilePic || `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${chat.name.charAt(0)}`}
                    alt={chat.name}
                    className="w-10 h-10 rounded-full object-cover"
                    onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${chat.name.charAt(0)}`; }}
                  />
                  <div>
                    <div className="font-semibold text-lg text-green-300">{chat.name}</div>
                    <div className="text-sm text-gray-400 truncate max-w-xs">{applyHighlighting(chat.summary)}</div>
                    {chat.lastMessageTimestamp && (
                      <div className="text-xs text-gray-500 mt-1">
                        {new Date(chat.lastMessageTimestamp.toDate()).toLocaleDateString('he-IL')} {new Date(chat.lastMessageTimestamp.toDate()).toLocaleTimeString('he-IL')}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </>
        )}

        {currentTab === 'contacts' && (
          <>
            <div className="p-4 border-b border-gray-700 flex flex-col gap-2">
                <input
                    type="text"
                    placeholder="×—×¤×© ××™×© ×§×©×¨..."
                    className="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={contactSearchTerm}
                    onChange={(e) => setContactSearchTerm(e.target.value)}
                    dir="rtl"
                />
                <button
                    onClick={() => setShowAddContactModal(true)}
                    className="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center text-sm"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" />
                    </svg>
                    ×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×©
                </button>
            </div>
            <div className="flex-grow overflow-y-auto custom-scrollbar">
              {filteredContacts.map((contact) => (
                <div
                  key={contact.id}
                  className="p-4 border-b border-gray-700 hover:bg-gray-700 flex items-center space-x-3 space-x-reverse"
                >
                  <img
                    src={contact.profilePic || `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${contact.name.charAt(0)}`}
                    alt={contact.name}
                    className="w-12 h-12 rounded-full object-cover border-2 border-gray-600 cursor-pointer"
                    onClick={() => handleContactClick(contact)}
                    onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${contact.name.charAt(0)}`; }}
                  />
                  <div className="flex-grow cursor-pointer" onClick={() => handleContactClick(contact)}>
                    <div className="font-semibold text-lg text-green-300">{contact.name}</div>
                    <div className="text-sm text-gray-400">{contact.whatsappNumber}</div>
                  </div>
                  <div className="flex space-x-2 space-x-reverse">
                    {!chatSummaries.some(chat => chat.contactId === contact.id) && (
                      <button
                        onClick={() => {setSelectedContact(contact); setShowUploadChatModal(true);}}
                        className="p-2 bg-gray-600 text-white rounded-full hover:bg-gray-500 transition-colors duration-200"
                        title="×”×¢×œ×” ×¦'××˜ ×œ××™×© ×§×©×¨ ×–×”"
                      >
                         â•ğŸ’¬
                      </button>
                    )}
                    <button
                      onClick={() => openReminderModal(contact.id)}
                      className="p-2 bg-purple-500 text-white rounded-full hover:bg-purple-600 transition-colors duration-200"
                      title="×¦×•×¨ ×ª×–×›×•×¨×ª"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </button>
                    {/* Placeholder for Office 365 Meeting */}
                    <button
                      onClick={() => createOffice365Meeting({ contact: contact.name, date: new Date() })}
                      className="p-2 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors duration-200"
                      title="×¦×•×¨ ×¤×’×™×©×ª 365"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </>
        )}
        <div className="p-4 bg-gray-900 text-sm border-t border-gray-700 rounded-b-lg">
          <p>×”××–×”×” ×©×œ×š: {userId || '×˜×•×¢×Ÿ...'}</p>
        </div>
      </div>

      {/* Main chat window */}
      <div className={`flex flex-col flex-grow ${isSidebarOpen ? 'md:w-2/3 lg:w-3/4' : 'w-full'} bg-gray-100 rounded-lg shadow-lg m-2`}>
        {/* Chat header */}
        <div className="bg-gradient-to-r from-teal-500 to-green-600 text-white p-4 rounded-t-lg shadow-md flex justify-between items-center">
          <div className="flex items-center space-x-3 space-x-reverse">
             <img
              src={currentContactProfilePic}
              alt={currentChatName}
              className="w-10 h-10 rounded-full object-cover border-2 border-white"
              onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${currentChatName.charAt(0)}`; }}
            />
            <h1 className="text-xl font-bold">{currentChatName}</h1>
          </div>
          <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-full hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>

        {/* Message display area */}
        <div className="flex-grow p-4 overflow-y-auto bg-gray-50 custom-scrollbar relative">
          {messages.length === 0 && (
            <p className="text-center text-gray-500 mt-10">
              {currentChatId ? "×”×¦'××˜ ×”×–×” ×¨×™×§. ×”×ª×—×œ ×©×™×—×”." : "×‘×—×¨ ×¦'××˜ ××”×¦×“, ××• ×”×¢×œ×” ×§×•×‘×¥ ×’×™×‘×•×™ ×©×œ WhatsApp."}
            </p>
          )}
          {messages.map((msg) => (
            <div
              key={msg.id}
              className={`flex mb-4 ${msg.sender === myContactName ? 'justify-end' : 'justify-start'}`}
            >
              <div className={`relative max-w-[80%] px-4 py-2 rounded-lg shadow ${msg.sender === myContactName ? 'bg-green-200 text-right mr-2' : 'bg-white text-left ml-2'}`}>
                <div className="font-bold text-sm mb-1">{msg.sender === myContactName ? '××ª×”' : msg.sender}</div>
                <p className="text-gray-800" dir="rtl">{applyHighlighting(msg.message)}</p>
                <div className="text-xs text-gray-500 mt-1 text-left">
                  {msg.timestamp && new Date(msg.timestamp.toDate()).toLocaleTimeString('he-IL')}
                </div>
              </div>
            </div>
          ))}
          <div ref={messagesEndRef} />
        </div>

        {/* System messages and loading indicator */}
        {systemMessage && (
          <div className="p-2 text-sm text-center bg-blue-100 text-blue-800 border-t border-blue-200">
            {systemMessage}
          </div>
        )}
        {loading && (
          <div className="p-2 text-sm text-center bg-yellow-100 text-yellow-800 border-t border-yellow-200">
            ×˜×•×¢×Ÿ... ×× × ×”××ª×Ÿ.
          </div>
        )}

        {/* Message input and action buttons */}
        <div className="p-4 bg-gray-200 rounded-b-lg shadow-inner flex items-center space-x-2 space-x-reverse">
          <button
            onClick={openOrderModal}
            className="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
            title="×¦×•×¨ ×”×–×× ×” ×—×“×©×”"
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </button>
          <button
            onClick={() => openReminderModal(currentChatContact?.contactId)}
            className="p-3 bg-purple-500 text-white rounded-full hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200"
            title="×¦×•×¨ ×ª×–×›×•×¨×ª ×—×“×©×”"
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
          <input
            type="text"
            ref={chatInputRef}
            className="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
            placeholder="×”×§×œ×“ ×”×•×“×¢×”..."
            value={inputMessage}
            onChange={(e) => setInputMessage(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
            disabled={loading || !currentChatId}
            dir="rtl"
          />
          <button
            onClick={handleSendMessage}
            className="p-3 bg-green-500 text-white rounded-full hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200"
            disabled={loading || !currentChatId || !inputMessage.trim()}
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </div>
      </div>

      {/* Order Creation Modal */}
      {showOrderModal && (
        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 shadow-xl w-full max-w-md" dir="rtl">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">×¦×•×¨ ×”×–×× ×” ×—×“×©×”</h2>
            <div className="mb-4">
              <label htmlFor="customerName" className="block text-gray-700 text-sm font-bold mb-2">
                ×©× ×œ×§×•×—:
              </label>
              <input
                type="text"
                id="customerName"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={orderForm.customer}
                onChange={(e) => setOrderForm({ ...orderForm, customer: e.target.value })}
                required
              />
            </div>
            <div className="mb-4">
              <label htmlFor="orderItems" className="block text-gray-700 text-sm font-bold mb-2">
                ×¤×¨×˜×™ ×”×–×× ×” (×œ×“×•×’××”: ××œ×˜ x10, ×‘×œ×•×§ x50):
              </label>
              <textarea
                id="orderItems"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24"
                value={orderForm.items}
                onChange={(e) => setOrderForm({ ...orderForm, items: e.target.value })}
                required
              ></textarea>
            </div>
            <div className="mb-4">
              <label htmlFor="orderDate" className="block text-gray-700 text-sm font-bold mb-2">
                ×ª××¨×™×š ××¡×¤×§×”:
              </label>
              <input
                type="date"
                id="orderDate"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={orderForm.date}
                onChange={(e) => setOrderForm({ ...orderForm, date: e.target.value })}
              />
            </div>
            <div className="mb-6">
              <label htmlFor="orderNotes" className="block text-gray-700 text-sm font-bold mb-2">
                ×”×¢×¨×•×ª:
              </label>
              <textarea
                id="orderNotes"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-20"
                value={orderForm.notes}
                onChange={(e) => setOrderForm({ ...orderForm, notes: e.target.value })}
              ></textarea>
            </div>
            <div className="flex justify-end space-x-2 space-x-reverse">
              <button
                onClick={() => setShowOrderModal(false)}
                className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
              >
                ×‘×™×˜×•×œ
              </button>
              <button
                onClick={handleOrderSubmit}
                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
                disabled={loading}
              >
                {loading ? '×™×•×¦×¨...' : '×¦×•×¨ ×”×–×× ×”'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Reminder Creation Modal */}
      {showReminderModal && (
        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 shadow-xl w-full max-w-md" dir="rtl">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">×¦×•×¨ ×ª×–×›×•×¨×ª ×—×“×©×”</h2>
            <div className="mb-4">
              <label htmlFor="reminderTitle" className="block text-gray-700 text-sm font-bold mb-2">
                ×›×•×ª×¨×ª:
              </label>
              <input
                type="text"
                id="reminderTitle"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={reminderForm.title}
                onChange={(e) => setReminderForm({ ...reminderForm, title: e.target.value })}
                required
              />
            </div>
            <div className="mb-4">
              <label htmlFor="reminderDate" className="block text-gray-700 text-sm font-bold mb-2">
                ×ª××¨×™×š:
              </label>
              <input
                type="date"
                id="reminderDate"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={reminderForm.date}
                onChange={(e) => setReminderForm({ ...reminderForm, date: e.target.value })}
                required
              />
            </div>
            <div className="mb-4">
              <label htmlFor="reminderTime" className="block text-gray-700 text-sm font-bold mb-2">
                ×©×¢×”:
              </label>
              <input
                type="time"
                id="reminderTime"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={reminderForm.time}
                onChange={(e) => setReminderForm({ ...reminderForm, time: e.target.value })}
                required
              />
            </div>
            <div className="mb-6">
              <label htmlFor="reminderNotes" className="block text-gray-700 text-sm font-bold mb-2">
                ×”×¢×¨×•×ª:
              </label>
              <textarea
                id="reminderNotes"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-20"
                value={reminderForm.notes}
                onChange={(e) => setReminderForm({ ...reminderForm, notes: e.target.value })}
              ></textarea>
            </div>
            <div className="flex justify-end space-x-2 space-x-reverse">
              <button
                onClick={() => setShowReminderModal(false)}
                className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
              >
                ×‘×™×˜×•×œ
              </button>
              <button
                onClick={handleReminderSubmit}
                className="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
                disabled={loading}
              >
                {loading ? '×™×•×¦×¨...' : '×¦×•×¨ ×ª×–×›×•×¨×ª'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Contact Detail Modal (Internal Page Simulation) */}
      {showContactDetailModal && selectedContact && (
        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 shadow-xl w-full max-w-2xl" dir="rtl">
            <div className="flex justify-between items-center mb-4 border-b pb-4">
              <h2 className="text-2xl font-bold text-gray-800">×¤×¨×˜×™ ××™×© ×§×©×¨: {selectedContact.name}</h2>
              <button
                onClick={() => setShowContactDetailModal(false)}
                className="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div className="flex items-center space-x-4 space-x-reverse mb-6">
              <img
                src={selectedContact.profilePic || `https://placehold.co/150x150/A3A9B2/FFFFFF?text=${selectedContact.name.charAt(0)}`}
                alt={selectedContact.name}
                className="w-24 h-24 rounded-full object-cover border-4 border-teal-500"
                onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/150x150/A3A9B2/FFFFFF?text=${selectedContact.name.charAt(0)}`; }}
              />
              <div>
                <p className="text-xl font-semibold text-gray-800">{selectedContact.name}</p>
                <p className="text-gray-600">{selectedContact.whatsappNumber}</p>
                {selectedContact.email && <p className="text-gray-600">××™××™×™×œ: {selectedContact.email}</p>}
                {selectedContact.address && <p className="text-gray-600">×›×ª×•×‘×ª: {selectedContact.address}</p>}
                {selectedContact.socialMedia && <p className="text-gray-600">×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª: <a href={selectedContact.socialMedia} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">{selectedContact.socialMedia}</a></p>}
              </div>
            </div>

            <h3 className="text-xl font-bold mb-3 text-gray-800">×¤×¢×•×œ×•×ª:</h3>
            <div className="flex flex-wrap gap-3 mb-6">
              <button
                onClick={() => {
                  setShowContactDetailModal(false);
                  openReminderModal(selectedContact.id);
                }}
                className="p-3 bg-purple-500 text-white rounded-full hover:bg-purple-600 transition-colors duration-200 flex items-center"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                ×¦×•×¨ ×ª×–×›×•×¨×ª
              </button>
              <button
                onClick={() => {
                  setShowContactDetailModal(false);
                  createOffice365Meeting({ contact: selectedContact.name, date: new Date() }); // Placeholder
                }}
                className="p-3 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors duration-200 flex items-center"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                ×–×™××•×Ÿ ×¤×’×™×©×ª 365
              </button>
              <button
                onClick={() => {
                  setShowContactDetailModal(false);
                  uploadToGoogleDrive(new File(["dummy content"], "example.txt"), selectedContact.id); // Placeholder for actual file object
                  setSystemMessage(`×”×¢×œ××ª ×§×•×‘×¥ ×œ-Google Drive ×¢×‘×•×¨ ${selectedContact.name} (×¡×™××•×œ×¦×™×”)...`);
                }}
                className="p-3 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors duration-200 flex items-center"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                ×”×¢×œ×” ××“×™×” ×œ-Drive
              </button>
            </div>

            <h3 className="text-xl font-bold mb-3 text-gray-800">×”×™×¡×˜×•×¨×™×™×ª ×¦'××˜:</h3>
            <div className="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50 custom-scrollbar">
              {chatSummaries.filter(chat => chat.contactId === selectedContact.id).length > 0 ? (
                messages.filter(msg => chatSummaries.find(chat => chat.id === currentChatId && chat.contactId === selectedContact.id)).map((msg) => (
                  <div key={msg.id} className={`flex mb-2 ${msg.sender === myContactName ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[80%] px-3 py-1 rounded-lg shadow-sm text-sm ${msg.sender === myContactName ? 'bg-green-100' : 'bg-gray-100'}`}>
                      <span className="font-bold">{msg.sender === myContactName ? '××ª×”' : msg.sender}: </span>
                      <span dangerouslySetInnerHTML={{ __html: applyHighlighting(msg.message) }} />
                      <div className="text-xs text-gray-500 mt-1 text-left">
                        {msg.timestamp && new Date(msg.timestamp.toDate()).toLocaleTimeString('he-IL')}
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <p className="text-center text-gray-500">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¦"××˜ ×¢×‘×•×¨ ××™×© ×§×©×¨ ×–×”.</p>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Add New Contact Modal */}
      {showAddContactModal && (
        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 shadow-xl w-full max-w-md" dir="rtl">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×©</h2>
            <div className="mb-4">
              <label htmlFor="newContactName" className="block text-gray-700 text-sm font-bold mb-2">
                ×©×:
              </label>
              <input
                type="text"
                id="newContactName"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={newContactForm.name}
                onChange={(e) => setNewContactForm({ ...newContactForm, name: e.target.value })}
                required
              />
            </div>
            <div className="mb-4">
              <label htmlFor="newContactNumber" className="block text-gray-700 text-sm font-bold mb-2">
                ××¡×¤×¨ ×•×•××˜×¡××¤:
              </label>
              <input
                type="text"
                id="newContactNumber"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={newContactForm.whatsappNumber}
                onChange={(e) => setNewContactForm({ ...newContactForm, whatsappNumber: e.target.value })}
              />
            </div>
            <div className="mb-4">
              <label htmlFor="newContactProfilePic" className="block text-gray-700 text-sm font-bold mb-2">
                ×œ×™× ×§ ×œ×ª××•× ×ª ×¤×¨×•×¤×™×œ:
              </label>
              <input
                type="text"
                id="newContactProfilePic"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={newContactForm.profilePic}
                onChange={(e) => setNewContactForm({ ...newContactForm, profilePic: e.target.value })}
              />
            </div>
            <div className="mb-4">
              <label htmlFor="newContactEmail" className="block text-gray-700 text-sm font-bold mb-2">
                ××™××™×™×œ:
              </label>
              <input
                type="email"
                id="newContactEmail"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={newContactForm.email}
                onChange={(e) => setNewContactForm({ ...newContactForm, email: e.target.value })}
              />
            </div>
            <div className="mb-4">
              <label htmlFor="newContactAddress" className="block text-gray-700 text-sm font-bold mb-2">
                ×›×ª×•×‘×ª:
              </label>
              <input
                type="text"
                id="newContactAddress"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={newContactForm.address}
                onChange={(e) => setNewContactForm({ ...newContactForm, address: e.target.value })}
              />
            </div>
            <div className="mb-6">
              <label htmlFor="newContactSocialMedia" className="block text-gray-700 text-sm font-bold mb-2">
                ×œ×™× ×§ ×œ×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª:
              </label>
              <input
                type="text"
                id="newContactSocialMedia"
                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                value={newContactForm.socialMedia}
                onChange={(e) => setNewContactForm({ ...newContactForm, socialMedia: e.target.value })}
              />
            </div>
            <div className="flex justify-end space-x-2 space-x-reverse">
              <button
                onClick={() => setShowAddContactModal(false)}
                className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
              >
                ×‘×™×˜×•×œ
              </button>
              <button
                onClick={handleCreateNewContact}
                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
                disabled={loading}
              >
                {loading ? '×™×•×¦×¨...' : '×¦×•×¨ ××™×© ×§×©×¨'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Upload Chat for New Contact Modal */}
      {showUploadChatModal && selectedContact && (
        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 shadow-xl w-full max-w-md" dir="rtl">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">×”×¢×œ×” ×¦'××˜ ×¢×‘×•×¨ {selectedContact.name}</h2>
            <p className="mb-4 text-gray-700">
              ×× × ×”×¢×œ×” ×§×•×‘×¥ ×’×™×‘×•×™ ×¦'××˜ (.txt) ×›×“×™ ×œ×™×™×‘× ×”×™×¡×˜×•×¨×™×™×ª ×”×•×“×¢×•×ª ×œ××™×© ×§×©×¨ ×–×”.
            </p>
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2" htmlFor="uploadChatFile">
                ×‘×—×¨ ×§×•×‘×¥ ×¦'××˜:
              </label>
              <input
                type="file"
                id="uploadChatFile"
                accept=".txt"
                onChange={(e) => {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                      handleUploadChatForNewContact(event.target.result);
                    };
                    reader.readAsText(file);
                  }
                }}
                className="w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-500 file:text-white hover:file:bg-green-600 cursor-pointer"
                disabled={loading}
              />
            </div>
            <div className="flex justify-end space-x-2 space-x-reverse">
              <button
                onClick={() => setShowUploadChatModal(false)}
                className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
              >
                ×‘×™×˜×•×œ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;

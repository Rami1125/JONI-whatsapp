<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¢×¨×›×ª CRM ××ª×§×“××ª - WhatsApp & Sheets</title>
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter (Tailwind default, good for multi-language) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* Custom scrollbar styling for better UX */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #4a5568; /* Tailwind gray-700 */
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #a0aec0; /* Tailwind gray-400 */
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #cbd5e0; /* Tailwind gray-300 */
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Custom WhatsApp green color */
    .bg-whatsapp-green {
      background-color: #25d366;
    }
    .hover:bg-whatsapp-dark-green:hover {
      background-color: #1DA851;
    }
  </style>

  <!-- React and ReactDOM CDNs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Firebase CDN (import as modules in the app script) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc,
      where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { v4 as uuidv4 } from "https://jspm.dev/uuid@8.3.2"; // ES Module import for uuid

    // --- Firebase Configuration (IMPORTANT: Replace with your actual Firebase config for GitHub Pages) ---
    // In a production GitHub Pages environment, you would replace these with your actual Firebase config values.
    // For Canvas environment, these are injected. Using fallbacks for self-contained HTML.
    const firebaseConfig = typeof __firebase_config !== "undefined" ? JSON.parse(__firebase_config) : {
      // Example:
      // apiKey: "YOUR_API_KEY",
      // authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      // projectId: "YOUR_PROJECT_ID",
      // storageBucket: "YOUR_PROJECT_ID.appspot.com",
      // messagingSenderId: "YOUR_SENDER_ID",
      // appId: "YOUR_APP_ID"
    };

    const appId = typeof __app_id !== "undefined" ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;


    // --- JONI Integration Constants (PLACEHOLDER) ---
    const JONI_SEND_API_URL = "YOUR_JONI_SEND_API_ENDPOINT_HERE";
    const JONI_API_KEY = "YOUR_JONI_API_KEY_HERE";

    // --- Gemini API Configuration ---
    // Canvas will automatically provide this at runtime. Leave empty string.
    const GEMINI_API_KEY = ""; 
    const GEMINI_TEXT_MODEL = "gemini-2.5-flash-preview-05-20";

    // --- Google Apps Script Web App URL ---
    // !!! IMPORTANT: This URL is crucial. Make sure it's correct and your Apps Script is deployed as a Web App (Execute as: Me, Who has access: Anyone) !!!
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw5KjrLqaNmtBnWoTaRRK5qajokT4JTei975kdqwEhXNIvxkUfZMCIwz9e5aTmQWCcTA/exec";

    // --- Google Drive & Office 365 Placeholders (Client-Side Simulation) ---
    const uploadToGoogleDrive = async (file, contactId) => {
      console.log(`Simulating upload of file ${file.name} to Google Drive for contact ${contactId}`);
      return new Promise(resolve => setTimeout(() => resolve(`https://drive.google.com/file/${uuidv4()}`), 1500));
    };

    const createOffice365Meeting = async (details) => {
      console.log("Simulating Office 365 meeting creation:", details);
      return new Promise(resolve => setTimeout(() => resolve(`https://outlook.office.com/calendar/meeting/${uuidv4()}`), 1500));
    };

    const App = () => {
      const [messages, setMessages] = React.useState([]);
      const [inputMessage, setInputMessage] = React.useState('');
      const [currentChatId, setCurrentChatId] = React.useState(null);
      const [chatSummaries, setChatSummaries] = React.useState([]);
      const [contacts, setContacts] = React.useState([]);
      const [selectedFile, setSelectedFile] = React.useState(null);
      const [myContactName, setMyContactName] = React.useState('×¨×××™ ××¡××¨×•×”');
      const [myProfilePic, setMyProfilePic] = React.useState('https://i.postimg.cc/2817JMT2/2025-08-24-044258.png');
      const [systemMessage, setSystemMessage] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [isSidebarOpen, setIsSidebarOpen] = React.useState(true);
      const [showOrderModal, setShowOrderModal] = React.useState(false);
      const [showReminderModal, setShowReminderModal] = React.useState(false);
      const [showContactDetailModal, setShowContactDetailModal] = React.useState(false);
      const [showAddContactModal, setShowAddContactModal] = React.useState(false);
      const [showUploadChatModal, setShowUploadChatModal] = React.useState(false);
      const [selectedContact, setSelectedContact] = React.useState(null);
      const [orderForm, setOrderForm] = React.useState({ customer: '', items: '', date: '', notes: '' });
      const [reminderForm, setReminderForm] = React.useState({ title: '', date: '', time: '', notes: '', contactId: null });
      const [newContactForm, setNewContactForm] = React.useState({ name: '', whatsappNumber: '', profilePic: '', email: '', address: '', socialMedia: '' });
      const [currentTab, setCurrentTab] = React.useState('chats');
      const [userId, setUserId] = React.useState(null);
      const [db, setDb] = React.useState(null);
      const [auth, setAuth] = React.useState(null);
      const [isAuthReady, setIsAuthReady] = React.useState(false);
      const messagesEndRef = React.useRef(null);
      const chatInputRef = React.useRef(null);
      const [contactSearchTerm, setContactSearchTerm] = React.useState('');
      const [showKeyboard, setShowKeyboard] = React.useState(false);

      const highlightRules = [
        { regex: /(×”×–×× ×” ×—×“×©×”|×“×—×•×£|×˜×™×¤×•×œ|×œ× ×˜×•×¤×œ|×¦×¨×™×š ×œ×‘×“×•×§)/g, className: 'bg-yellow-200 font-bold' },
        { regex: /(×ª×–×›×•×¨×ª|×™×•××Ÿ|××—×¨|×”×™×•×)/g, className: 'bg-blue-200 font-bold' },
        { regex: /(×‘×¢×™×”|×ª×§×œ×”|×—×¡×¨)/g, className: 'bg-red-200 font-bold' },
      ];

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      // Firebase Initialization and Auth
      React.useEffect(() => {
        const app = initializeApp(firebaseConfig);
        const firestoreDb = getFirestore(app);
        const firebaseAuth = getAuth(app);

        setDb(firestoreDb);
        setAuth(firebaseAuth);

        const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            if (initialAuthToken) {
              try {
                await signInWithCustomToken(firebaseAuth, initialAuthToken);
              } catch (error) {
                console.error("Error signing in with custom token:", error);
                await signInAnonymously(firebaseAuth);
              }
            } else {
              await signInAnonymously(firebaseAuth);
            }
          }
          setIsAuthReady(true);
        });

        return () => unsubscribe();
      }, []); // Empty dependency array means this runs once on mount

      // Fetch chat summaries, contacts, and active chat messages once authenticated
      React.useEffect(() => {
        if (!isAuthReady || !db || !userId) return;

        // Fetch contacts
        const qContacts = query(collection(db, `artifacts/${appId}/users/${userId}/contacts`), orderBy('name'));
        const unsubscribeContacts = onSnapshot(qContacts, (snapshot) => {
          setContacts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }, (error) => {
          console.error("Error fetching contacts:", error);
          setSystemMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×× ×©×™ ×§×©×¨.");
        });

        // Fetch chat summaries
        const qChats = query(collection(db, `artifacts/${appId}/users/${userId}/chats`), orderBy('lastMessageTimestamp', 'desc'));
        const unsubscribeChats = onSnapshot(qChats, (snapshot) => {
          const summaries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setChatSummaries(summaries);
          if (!currentChatId && summaries.length > 0) {
            setCurrentChatId(summaries[0].id);
          }
        }, (error) => {
          console.error("Error fetching chat summaries:", error);
          setSystemMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×™×›×•××™ ×¦'××˜×™×.");
        });

        // Fetch messages for the currently selected chat
        let unsubscribeMessages = () => {};
        if (currentChatId) {
          const qMessages = query(collection(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}/messages`), orderBy('timestamp'));
          unsubscribeMessages = onSnapshot(qMessages, (snapshot) => {
            const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMessages(msgs);
            scrollToBottom();
          }, (error) => {
            console.error("Error fetching messages:", error);
            setSystemMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×•×“×¢×•×ª ×¦'××˜.");
          });
        }

        return () => {
          unsubscribeContacts();
          unsubscribeChats();
          unsubscribeMessages();
        };
      }, [isAuthReady, db, userId, currentChatId, appId]); // Added appId to dependencies

      // Helper to send data to Google Apps Script
      const sendDataToGoogleSheet = async (type, data) => {
        if (GOOGLE_APPS_SCRIPT_URL === "YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE" || !GOOGLE_APPS_SCRIPT_URL) {
          console.warn("Google Apps Script URL not configured. Data will not be synced to Sheets.");
          return;
        }
        try {
          const payload = {
            type: type,
            userId: userId,
            appId: appId, // Use the dynamically retrieved appId
            data: data,
          };

          const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (result.status === 'success') {
            console.log(`Successfully synced ${type} to Google Sheet:`, result.message);
          } else {
            console.error(`Error syncing ${type} to Google Sheet:`, result.message);
            setSystemMessage(`×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ×œ×’×™×œ×™×•×Ÿ: ${result.message}`);
          }
        } catch (error) {
          console.error(`Network error syncing ${type} to Google Sheet:`, error);
          setSystemMessage(`×©×’×™××ª ×¨×©×ª ×‘×¡× ×›×¨×•×Ÿ ×œ×’×™×œ×™×•×Ÿ: ${error.message}`);
        }
      };


      // Handle file upload (WhatsApp .txt backup or .vcf)
      const handleFileSelect = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        setSelectedFile(file);
        setLoading(true);
        setSystemMessage('××¢×‘×“ ×§×•×‘×¥ ×’×™×‘×•×™...');

        try {
          const fileContent = await file.text();
          if (file.name.endsWith('.txt')) {
            await processWhatsAppChatFile(fileContent, file.name);
          } else if (file.name.endsWith('.vcf')) {
            await processVCardFile(fileContent);
          } else {
            setSystemMessage('×¤×•×¨××˜ ×§×•×‘×¥ ×œ× × ×ª××š. ×× × ×”×¢×œ×” ×§×•×‘×¥ .txt ××• .vcf.');
          }
        } catch (error) {
          console.error("Error processing file:", error);
          setSystemMessage(`×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥: ${error.message}`);
        } finally {
          setLoading(false);
          setSelectedFile(null);
        }
      };

      const processWhatsAppChatFile = async (fileContent, fileName) => {
        const parsedMessages = parseWhatsAppChat(fileContent);

        if (parsedMessages.length === 0) {
          setSystemMessage('×œ× × ××¦××• ×”×•×“×¢×•×ª ×‘×§×•×‘×¥ ×”×’×™×‘×•×™. ×•×“× ×©×”×¤×•×¨××˜ × ×›×•×Ÿ.');
          return;
        }

        let chatName = fileName.replace(".txt", "").replace("â€×¦'××˜ WhatsApp ×¢× â€â€ª", "").replace("â€¬â€", "");
        const phoneRegex = /\+?\d{9,15}/;
        const phoneMatch = chatName.match(phoneRegex);

        if (phoneMatch) {
          chatName = chatName.replace(phoneMatch[0], "").trim();
        }

        let contactDoc = contacts.find(c => c.name === chatName || c.whatsappNumber === phoneMatch?.[0]);
        let contactId;
        let contactWhatsAppNumber = phoneMatch ? formatWhatsappNumber(phoneMatch[0]) : ""; // Initialize here

        if (!contactDoc) {
          const newContactData = {
            name: chatName,
            whatsappNumber: contactWhatsAppNumber, // Use the formatted number
            profilePic: `https://placehold.co/100x100/F0F2F5/A3A9B2?text=${chatName.charAt(0)}`,
            createdAt: serverTimestamp(),
          };
          const newContactRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/contacts`), newContactData);
          contactId = newContactRef.id;
          contactDoc = { id: contactId, ...newContactData };
          await sendDataToGoogleSheet('saveContactToSheet', newContactData); // Sync new contact to Sheets
        } else {
          contactId = contactDoc.id;
          contactWhatsAppNumber = contactDoc.whatsappNumber; // Get existing formatted number
        }

        let chatRef;
        const existingChatQuery = query(collection(db, `artifacts/${appId}/users/${userId}/chats`), where('contactId', "==", contactId));
        const existingChatSnapshot = await getDocs(existingChatQuery);

        if (!existingChatSnapshot.empty) {
          chatRef = existingChatSnapshot.docs[0].ref;
          await updateDoc(chatRef, {
            lastMessageTimestamp: parsedMessages[parsedMessages.length - 1].timestamp,
            summary: parsedMessages[parsedMessages.length - 1].message,
            contactName: contactDoc.name,
          });
        } else {
          chatRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chats`), {
            name: contactDoc.name,
            contactId: contactId,
            lastMessageTimestamp: parsedMessages[parsedMessages.length - 1].timestamp,
            summary: parsedMessages[parsedMessages.length - 1].message,
            createdAt: serverTimestamp(),
          });
        }
        setCurrentChatId(chatRef.id);

        const messagesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats/${chatRef.id}/messages`);
        for (const msg of parsedMessages) {
          await addDoc(messagesCollectionRef, {
            sender: msg.sender,
            message: msg.message,
            timestamp: msg.timestamp,
            originalTimestamp: msg.originalTimestamp
          });
        }
        setSystemMessage("×§×•×‘×¥ ×’×™×‘×•×™ ×¦'××˜ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×”×”×•×“×¢×•×ª × ×©××¨×• ×‘-Firestore.");
        // Sync chat messages to Google Sheet, including contactWhatsAppNumber
        await sendDataToGoogleSheet('saveChatToSheet', {
          chatId: chatRef.id,
          contactName: contactDoc.name,
          contactWhatsAppNumber: contactWhatsAppNumber, // Pass the WhatsApp number here
          messages: parsedMessages.map(msg => ({ // Send serializable data
            sender: msg.sender,
            message: msg.message,
            timestamp: msg.timestamp.toISOString(),
          })),
        });
      };

      const processVCardFile = async (fileContent) => {
        const vcfs = fileContent.split('END:VCARD').filter(block => block.trim() !== '').map(block => block + 'END:VCARD');

        for (const vcf of vcfs) {
          const nameMatch = vcf.match(/FN:(.*)/);
          const telMatch = vcf.match(/TEL;waid=(\+?\d+):(\+?\d+)/) || vcf.match(/TEL;type=CELL;type=VOICE:(\+?\d+)/);
          const photoMatch = vcf.match(/PHOTO;BASE64:(.*)/s);

          const name = nameMatch ? nameMatch[1].trim() : '×©× ×œ× ×™×“×•×¢';
          const whatsappNumber = telMatch ? formatWhatsappNumber((telMatch[1] || telMatch[2]).trim()) : '';
          const profilePicBase64 = photoMatch ? photoMatch[1].trim() : '';

          let profilePicUrl = `https://placehold.co/100x100/F0F2F5/A3A9B2?text=${name.charAt(0)}`;
          if (profilePicBase64 && profilePicBase64.length < 200) { // Avoid sending very long base64 over to placeholder
            profilePicUrl = `data:image/png;base64,${profilePicBase64}`; // Temporarily use base64
            console.log(`Base64 image for ${name} found. In a real app, this would be uploaded to storage.`);
          }

          const existingContact = contacts.find(c => (c.whatsappNumber && c.whatsappNumber === whatsappNumber) || c.name === name);

          const contactData = {
            name: name,
            whatsappNumber: whatsappNumber,
            profilePic: profilePicUrl,
            createdAt: serverTimestamp(),
          };

          if (existingContact) {
            await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/contacts`, existingContact.id), contactData);
          } else {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/contacts`), contactData);
          }
          await sendDataToGoogleSheet('saveContactToSheet', contactData); // Sync contact to Sheets
        }
        setSystemMessage('×§×•×‘×¥ ×× ×©×™ ×§×©×¨ (.vcf) × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×× ×©×™ ×”×§×©×¨ × ×©××¨×•/×¢×•×“×›× ×• ×‘-Firestore ×•×‘-Google Sheet.');
      };

      const parseWhatsAppChat = (chatContent) => {
        const messages = [];
        const lines = chatContent.split('\n');
        // Updated regex to correctly match Hebrew AM/PM indicators and the actual input format
        // Format: DD.MM.YYYY, HH:MM AM/PM - SENDER: MESSAGE
        const regex = /^(\d{1,2}\.\d{1,2}\.\d{4}), (\d{1,2}:\d{2} (×‘×•×§×¨|×œ×¤× ×•×ª ×‘×•×§×¨|×¦×”×¨×™×™×|××—×¨ ×”×¦×”×¨×™×™×|×¢×¨×‘|×œ×™×œ×”)) - (.*?): (.*)/;

        let currentMessage = null;

        for (const line of lines) {
          const match = line.match(regex);
          if (match) {
            if (currentMessage) {
              messages.push(currentMessage);
            }
            // Group 1: dateStr (DD.MM.YYYY)
            // Group 2: timeStrFull (HH:MM AM/PM) - e.g., "10:39 ×‘×•×§×¨"
            // Group 4: sender (captures after " - ")
            // Group 5: message (rest of the line after sender:)
            const [, dateStr, timeStrFull, , sender, message] = match; // Note: there's an extra group for (×‘×•×§×¨|...) that we skip with empty comma
            const formattedDate = formatHebrewDateTime(`${dateStr}, ${timeStrFull}`);
            currentMessage = {
              sender: sender.trim(),
              message: message.trim(),
              timestamp: formattedDate,
              originalTimestamp: `${dateStr}, ${timeStrFull}`
            };
          } else if (currentMessage) {
            // If it's a continuation line for the previous message
            currentMessage.message += '\n' + line.trim();
          }
        }
        if (currentMessage) {
          messages.push(currentMessage);
        }
        return messages;
      };

      const formatHebrewDateTime = (hebrewDateTime) => {
        // hebrewDateTime example: "12.9.2020, 10:39 ×‘×•×§×¨"
        let [datePart, timePart] = hebrewDateTime.split(', '); // "12.9.2020" and "10:39 ×‘×•×§×¨"
        const [day, month, year] = datePart.split('.').map(Number); // Note: split by '.' for DD.MM.YYYY
        let [time, ampm] = timePart.split(' '); // "10:39" and "×‘×•×§×¨"

        let [hours, minutes] = time.split(':').map(Number); // No seconds in this format, so only hours and minutes

        if (ampm) {
            if (ampm.includes('×œ×¤× ×•×ª ×‘×•×§×¨') && hours === 12) { hours = 0; } // Handle 12 AM (midnight)
            else if (ampm.includes('×¦×”×¨×™×™×') && hours < 12) { hours += 12; } // Handle PM for times before 12
            else if (ampm.includes('××—×¨ ×”×¦×”×¨×™×™×') && hours < 12) { hours += 12; }
            else if (ampm.includes('×¢×¨×‘') && hours < 12) { hours += 12; }
            else if (ampm.includes('×œ×™×œ×”') && hours < 12) { hours += 12; }
             // '×‘×•×§×¨' needs no hour adjustment unless 12 AM which is covered above
        }

        // Return a Date object. Seconds are implicitly 0.
        return new Date(year, month - 1, day, hours, minutes, 0);
      };

      const formatWhatsappNumber = (number) => {
        // Remove all non-digit characters
        let cleaned = number.replace(/\D/g, '');
        // If it starts with 0 and is not a full international number (e.g., 052-...)
        if (cleaned.startsWith('0') && cleaned.length === 10) {
          cleaned = '972' + cleaned.substring(1);
        }
        // Ensure it has a '+' prefix for wa.me links
        return cleaned.startsWith('+') ? cleaned : `+${cleaned}`;
      };

      const handleSendMessage = async () => {
        if (!inputMessage.trim() || !currentChatId || !db || !userId) return;

        setLoading(true);
        try {
          const newMessage = {
            sender: myContactName,
            message: inputMessage.trim(),
            timestamp: new Date(),
          };

          const messagesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}/messages`);
          await addDoc(messagesCollectionRef, newMessage);

          const chatRef = doc(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}`);
          await updateDoc(chatRef, {
            lastMessageTimestamp: newMessage.timestamp,
            summary: newMessage.message,
          });

          setInputMessage('');
          setSystemMessage('×”×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×•× ×©××¨×” ×‘-Firestore.');

          if (JONI_SEND_API_URL !== "YOUR_JONI_SEND_API_ENDPOINT_HERE") {
            console.log("Simulating sending message via JONI:", newMessage);
          }

        } catch (error) {
          console.error("Error sending message:", error);
          setSystemMessage(`×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      const openOrderModal = React.useCallback(() => {
        setShowOrderModal(true);
        if (currentChatId) {
          const selectedChat = chatSummaries.find(chat => chat.id === currentChatId);
          const contact = contacts.find(c => c.id === selectedChat?.contactId);
          if (contact && !contact.name.startsWith('×§×‘×•×¦×”:')) {
            setOrderForm(prev => ({ ...prev, customer: contact.name }));
          }
        }
      }, [currentChatId, chatSummaries, contacts]);

      const handleOrderSubmit = async () => {
        if (!orderForm.customer || !orderForm.items || !db || !userId) {
          setSystemMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×” ×‘×”×–×× ×”.');
          return;
        }

        setLoading(true);
        try {
          const contact = contacts.find(c => c.name === orderForm.customer);
          let orderChatId = currentChatId;

          if (!orderChatId && contact) {
              const existingChatQuery = query(collection(db, `artifacts/${appId}/users/${userId}/chats`), where('contactId', "==", contact.id));
              const existingChatSnapshot = await getDocs(existingChatQuery);
              if (!existingChatSnapshot.empty) {
                  orderChatId = existingChatSnapshot.docs[0].id;
              } else {
                  const newChatRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chats`), {
                      name: contact.name,
                      contactId: contact.id,
                      lastMessageTimestamp: new Date(),
                      summary: '×”×–×× ×” × ×•×¦×¨×”',
                      createdAt: serverTimestamp(),
                  });
                  orderChatId = newChatRef.id;
                  setCurrentChatId(orderChatId);
              }
          } else if (!orderChatId && !contact) {
              setSystemMessage('×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×”×–×× ×” ×œ×œ× ×¦"××˜ × ×‘×—×¨ ××• ×œ×§×•×— ×§×™×™×.');
              setLoading(false);
              return;
          }

          const newOrderData = {
            chatId: orderChatId,
            customer: orderForm.customer,
            items: orderForm.items,
            date: orderForm.date ? new Date(orderForm.date) : serverTimestamp(),
            notes: orderForm.notes,
            status: '×—×“×©',
            createdAt: serverTimestamp(),
          };
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/orders`), newOrderData);
          await sendDataToGoogleSheet('saveOrderToSheet', {
            ...newOrderData,
            date: newOrderData.date instanceof Date ? newOrderData.date.toISOString() : newOrderData.date // Ensure date is serializable
          });


          const orderMessage = `ğŸ“¦ ×”×–×× ×” ×—×“×©×” ×¢×‘×•×¨ ${orderForm.customer}:\n×¤×¨×™×˜×™×: ${orderForm.items}\n×ª××¨×™×š: ${orderForm.date || '×œ× ×¦×•×™×Ÿ'}\n×”×¢×¨×•×ª: ${orderForm.notes || '××™×Ÿ'}`;
          const newMessage = {
            sender: myContactName,
            message: orderMessage,
            timestamp: new Date(),
          };
          const messagesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats/${orderChatId}/messages`);
          await addDoc(messagesCollectionRef, newMessage);

          const chatRef = doc(db, `artifacts/${appId}/users/${userId}/chats/${orderChatId}`);
          await updateDoc(chatRef, {
            lastMessageTimestamp: newMessage.timestamp,
            summary: newMessage.message,
          });

          setOrderForm({ customer: '', items: '', date: '', notes: '' });
          setShowOrderModal(false);
          setSystemMessage('×”×–×× ×” × ×•×¦×¨×” ×•× ×©××¨×” ×‘×”×¦×œ×—×”!');
        } catch (error) {
          console.error("Error creating order:", error);
          setSystemMessage(`×©×’×™××” ×‘×™×¦×™×¨×ª ×”×–×× ×”: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      const openReminderModal = React.useCallback((contactId = null, draftText = '') => {
        setShowReminderModal(true);
        setReminderForm(prev => ({ ...prev, contactId: contactId, title: draftText || '' }));
        if (contactId && !draftText) {
          const contact = contacts.find(c => c.id === contactId);
          setReminderForm(prev => ({ ...prev, title: `×ª×–×›×•×¨×ª ×¢×‘×•×¨ ${contact?.name || ''}` }));
        }
      }, [contacts]);

      const handleReminderSubmit = async () => {
        if (!reminderForm.title || !reminderForm.date || !reminderForm.time || !db || !userId) {
          setSystemMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×” ×‘×ª×–×›×•×¨×ª.');
          return;
        }

        setLoading(true);
        try {
          const reminderDateTime = new Date(`${reminderForm.date}T${reminderForm.time}`);
          const newReminderData = {
            title: reminderForm.title,
            dateTime: reminderDateTime,
            notes: reminderForm.notes,
            contactId: reminderForm.contactId,
            status: '×¤×¢×™×œ',
            createdAt: serverTimestamp(),
          };
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/reminders`), newReminderData);
          await sendDataToGoogleSheet('saveReminderToSheet', {
            ...newReminderData,
            dateTime: newReminderData.dateTime.toISOString() // Ensure date is serializable
          });

          if (currentChatId) {
            const reminderMessage = `ğŸ”” ×ª×–×›×•×¨×ª ×—×“×©×”: ${reminderForm.title}\n××•×¢×“: ${new Date(reminderDateTime).toLocaleString('he-IL')}\n×”×¢×¨×•×ª: ${reminderForm.notes || '××™×Ÿ'}`;
            const newMessage = {
              sender: myContactName,
              message: reminderMessage,
              timestamp: new Date(),
            };
            const messagesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}/messages`);
            await addDoc(messagesCollectionRef, newMessage);

            const chatRef = doc(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}`);
            await updateDoc(chatRef, {
              lastMessageTimestamp: newMessage.timestamp,
              summary: newMessage.message,
            });
          }

          setReminderForm({ title: '', date: '', time: '', notes: '', contactId: null });
          setShowReminderModal(false);
          setSystemMessage('×ª×–×›×•×¨×ª × ×•×¦×¨×” ×•× ×©××¨×” ×‘×”×¦×œ×—×”!');
        } catch (error) {
          console.error("Error creating reminder:", error);
          setSystemMessage(`×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×–×›×•×¨×ª: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      const applyHighlighting = (text) => {
        let highlightedText = text;
        highlightRules.forEach(rule => {
          highlightedText = highlightedText.replace(rule.regex, (match) => `<span class="${rule.className}">${match}</span>`);
        });
        return React.createElement('span', { dangerouslySetInnerHTML: { __html: highlightedText } });
      };

      const currentChatName = chatSummaries.find(chat => chat.id === currentChatId)?.name || '×‘×—×¨ ×¦"××˜';
      const currentChatContact = chatSummaries.find(chat => chat.id === currentChatId);
      const currentContactProfilePic = contacts.find(c => c.id === currentChatContact?.contactId)?.profilePic || 'https://placehold.co/100x100/A3A9B2/FFFFFF?text=P';

      const handleContactClick = (contact) => {
        setSelectedContact(contact);
        setShowContactDetailModal(true);
        const existingChat = chatSummaries.find(chat => chat.contactId === contact.id);
        if (existingChat) {
          setCurrentChatId(existingChat.id);
        }
      };

      const handleCreateNewContact = async () => {
        if (!newContactForm.name.trim() || !db || !userId) {
          setSystemMessage('×× × ×”×–×Ÿ ×©× ×¢×‘×•×¨ ××™×© ×”×§×©×¨ ×”×—×“×©.');
          return;
        }
        setLoading(true);
        try {
          const contactData = {
            name: newContactForm.name.trim(),
            whatsappNumber: formatWhatsappNumber(newContactForm.whatsappNumber.trim()),
            profilePic: newContactForm.profilePic.trim() || `https://placehold.co/100x100/F0F2F5/A3A9B2?text=${newContactForm.name.charAt(0)}`,
            email: newContactForm.email.trim(),
            address: newContactForm.address.trim(),
            socialMedia: newContactForm.socialMedia.trim(),
            createdAt: serverTimestamp(),
          };
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/contacts`), contactData);
          await sendDataToGoogleSheet('saveContactToSheet', contactData); // Sync new contact to Sheets
          setNewContactForm({ name: '', whatsappNumber: '', profilePic: '', email: '', address: '', socialMedia: '' });
          setShowAddContactModal(false);
          setSystemMessage('××™×© ×§×©×¨ ×—×“×© × ×•×¦×¨ ×‘×”×¦×œ×—×” ×•×‘×¡×•× ×›×¨×Ÿ ×œ-Google Sheet!');
        } catch (error) {
          console.error("Error creating new contact:", error);
          setSystemMessage(`×©×’×™××” ×‘×™×¦×™×¨×ª ××™×© ×§×©×¨: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      const handleUploadChatForNewContact = async (fileContent) => {
        if (!selectedContact || !db || !userId) {
          setSystemMessage('×™×© ×œ×‘×—×•×¨ ××™×© ×§×©×¨ ×œ×¤× ×™ ×”×¢×œ××ª ×¦"××˜.');
          return;
        }
        setLoading(true);
        try {
          const parsedMessages = parseWhatsAppChat(fileContent);
          if (parsedMessages.length === 0) {
            setSystemMessage('×œ× × ××¦××• ×”×•×“×¢×•×ª ×‘×§×•×‘×¥ ×”×’×™×‘×•×™. ×•×“× ×©×”×¤×•×¨××˜ × ×›×•×Ÿ.');
            setLoading(false);
            return;
          }

          const chatRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chats`), {
            name: selectedContact.name,
            contactId: selectedContact.id,
            lastMessageTimestamp: parsedMessages[parsedMessages.length - 1].timestamp,
            summary: parsedMessages[parsedMessages.length - 1].message,
            createdAt: serverTimestamp(),
          });
          setCurrentChatId(chatRef.id);

          const messagesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats/${chatRef.id}/messages`);
          for (const msg of parsedMessages) {
            await addDoc(messagesCollectionRef, {
              sender: msg.sender,
              message: msg.message,
              timestamp: msg.timestamp,
              originalTimestamp: msg.originalTimestamp
            });
          }
          setShowUploadChatModal(false);
          setSystemMessage('×§×•×‘×¥ ×’×™×‘×•×™ ×¦"××˜ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×” ×œ××™×© ×”×§×©×¨!');
          // Sync chat messages to Google Sheet, including contactWhatsAppNumber
          await sendDataToGoogleSheet('saveChatToSheet', {
            chatId: chatRef.id,
            contactName: selectedContact.name,
            contactWhatsAppNumber: selectedContact.whatsappNumber, // Pass the WhatsApp number here
            messages: parsedMessages.map(msg => ({ // Send serializable data
              sender: msg.sender,
              message: msg.message,
              timestamp: msg.timestamp.toISOString(),
            })),
          });
        } catch (error) {
          console.error("Error uploading chat for new contact:", error);
          setSystemMessage(`×©×’×™××” ×‘×”×¢×œ××ª ×¦"××˜: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      const handlePaste = React.useCallback(async (event) => {
        if (currentTab !== 'chats' || !currentChatId) return;

        const pastedText = event.clipboardData.getData('text');
        if (pastedText) {
          setLoading(true);
          try {
            const newMessage = {
              sender: currentChatName,
              message: pastedText,
              timestamp: new Date(),
            };
            const messagesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}/messages`);
            await addDoc(messagesCollectionRef, newMessage);

            const chatRef = doc(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}`);
            await updateDoc(chatRef, {
              lastMessageTimestamp: newMessage.timestamp,
              summary: newMessage.message,
            });
            setSystemMessage('×”×•×“×¢×” ×©×”×•×“×‘×§×” × ×§×œ×˜×” ×‘×”×¦×œ×—×” ×•×©×•×™×›×” ×œ×¦"××˜.');
          } catch (error) {
            console.error("Error processing pasted text:", error);
            setSystemMessage(`×©×’×™××” ×‘×¢×™×‘×•×“ ×˜×§×¡×˜ ×©×”×•×“×‘×§: ${error.message}`);
          } finally {
            setLoading(false);
          }
        }
      }, [currentChatId, currentChatName, db, userId, currentTab, appId]);

      React.useEffect(() => {
        const inputElement = chatInputRef.current;
        if (inputElement && currentTab === 'chats') {
          inputElement.addEventListener('paste', handlePaste);
        }
        return () => {
          if (inputElement) {
            inputElement.removeEventListener('paste', handlePaste);
          }
        };
      }, [handlePaste, currentTab]);

      const filteredContacts = contacts.filter(contact =>
        contact.name.toLowerCase().includes(contactSearchTerm.toLowerCase()) ||
        contact.whatsappNumber.includes(contactSearchTerm)
      );

      const handleKeyboardInput = (char) => {
        setInputMessage(prev => prev + char);
      };

      const handleKeyboardDelete = () => {
        setInputMessage(prev => prev.slice(0, -1));
      };

      const handleKeyboardEnter = () => {
        handleSendMessage();
      };

      // --- Gemini API Call for Chat Summary ---
      const summarizeChat = async () => {
        if (!currentChatId || messages.length === 0) {
          setSystemMessage("××™×Ÿ ×¦'××˜ ××• ×”×•×“×¢×•×ª ×œ×¡×›×.");
          return;
        }

        setLoading(true);
        setSystemMessage('××¡×›× ××ª ×”×¦\'××˜ ×‘×××¦×¢×•×ª Gemini API...');

        try {
          const chatHistory = messages.map(msg => `${msg.sender}: ${msg.message}`).join('\n');
          const prompt = `×‘×‘×§×©×” ×¡×›× ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”×¦'××˜ ×”×‘××” ×‘× ×§×•×“×•×ª ×ª××¦×™×ª×™×•×ª: \n${chatHistory}\n\n×¡×™×›×•×:`;

          const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
          };

          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
          
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await response.json();
          
          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
            const summary = result.candidates[0].content.parts[0].text;
            setSystemMessage(`×¡×™×›×•× ×¦'××˜: ${summary}`);

            const newSummaryMessage = {
              sender: 'Gemini âœ¨',
              message: `âœ¨ ×¡×™×›×•× ×¦'××˜: ${summary}`,
              timestamp: new Date(),
            };
            const messagesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chats/${currentChatId}/messages`);
            await addDoc(messagesCollectionRef, newSummaryMessage);

          } else {
            setSystemMessage('×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×™×›×•× ×¦\'××˜. ××‘× ×” ×ª×’×•×‘×” ×œ× ×¦×¤×•×™.');
            console.error('Gemini API response was malformed:', result);
          }

        } catch (error) {
          console.error("Error summarizing chat:", error);
          setSystemMessage(`×©×’×™××” ×‘×¡×™×›×•× ×¦'××˜: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      // --- Gemini API Call for Smart Reminder Draft ---
      const draftSmartReminder = async () => {
        if (!inputMessage.trim()) {
          setSystemMessage("×× × ×”×§×œ×“ ×˜×§×¡×˜ ×‘×©×“×” ×”×”×•×“×¢×” ×›×“×™ ×œ×™×¦×•×¨ ×˜×™×•×˜×ª ×ª×–×›×•×¨×ª ×—×›××”.");
          return;
        }

        setLoading(true);
        setSystemMessage('×™×•×¦×¨ ×˜×™×•×˜×ª ×ª×–×›×•×¨×ª ×—×›××” ×‘×××¦×¢×•×ª Gemini API...');

        try {
          const prompt = `×‘×”×ª×‘×¡×¡ ×¢×œ ×”×˜×§×¡×˜ ×”×‘×: "${inputMessage}", × ×¡×— ×˜×™×•×˜×ª ×ª×–×›×•×¨×ª ×§×¦×¨×” ×•×××•×§×“×ª. ×× ×™×© ××–×›×•×¨ ×œ×ª××¨×™×š ××• ×©×¢×”, ×›×œ×•×œ ××•×ª× ×‘×˜×™×•×˜×”.`;

          const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
          };

          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
          
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await response.json();
          
          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
            const draft = result.candidates[0].content.parts[0].text;
            openReminderModal(currentChatContact?.contactId, draft);
            setSystemMessage('×˜×™×•×˜×ª ×ª×–×›×•×¨×ª ×—×›××” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
          } else {
            setSystemMessage('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×™×•×˜×ª ×ª×–×›×•×¨×ª. ××‘× ×” ×ª×’×•×‘×” ×œ× ×¦×¤×•×™.');
            console.error('Gemini API response was malformed:', result);
          }

        } catch (error) {
          console.error("Error drafting smart reminder:", error);
          setSystemMessage(`×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×™×•×˜×ª ×ª×–×›×•×¨×ª: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };


      if (!isAuthReady) {
        return (
          React.createElement('div', { className: "flex items-center justify-center min-h-screen bg-gray-100" },
            React.createElement('div', { className: "text-center text-gray-700" }, "×˜×•×¢×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”...")
          )
        );
      }

      return (
        React.createElement('div', { className: "flex h-screen w-full font-sans text-right bg-gray-900", dir: "rtl" },
          /* Sidebar for chat list or contacts list */
          React.createElement('div', { className: `transition-all duration-300 ${isSidebarOpen ? 'w-full md:w-1/3 lg:w-1/4' : 'w-0'} bg-gray-800 text-white flex-shrink-0 flex flex-col overflow-hidden rounded-lg shadow-xl m-2` },
            React.createElement('div', { className: "p-4 bg-gray-900 flex justify-between items-center rounded-t-lg" },
              React.createElement('div', { className: "flex items-center space-x-2 space-x-reverse" },
                React.createElement('img', { src: myProfilePic, alt: "My Profile", className: "w-10 h-10 rounded-full object-cover border-2 border-green-400" }),
                React.createElement('h2', { className: "text-xl font-bold" }, myContactName)
              ),
              React.createElement('button', { onClick: () => setIsSidebarOpen(!isSidebarOpen), className: "p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" },
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6 text-gray-300", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M4 6h16M4 12h16M4 18h16" })
                )
              )
            ),

            /* Tab Navigation for Sidebar */
            React.createElement('div', { className: "flex justify-around bg-gray-700 p-2 border-b border-gray-600" },
              React.createElement('button', {
                className: `flex-1 p-2 rounded-lg font-semibold ${currentTab === 'chats' ? 'bg-green-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-600'}`,
                onClick: () => setCurrentTab('chats')
              }, "×”×•×“×¢×•×ª"),
              React.createElement('button', {
                className: `flex-1 p-2 rounded-lg font-semibold ${currentTab === 'contacts' ? 'bg-green-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-600'}`,
                onClick: () => setCurrentTab('contacts')
              }, "×× ×©×™ ×§×©×¨")
            ),

            currentTab === 'chats' && (
              React.createElement(React.Fragment, null,
                React.createElement('div', { className: "p-4 border-b border-gray-700" },
                  React.createElement('label', { className: "block text-sm font-medium text-gray-300 mb-2", htmlFor: "whatsappFileInput" }, "×”×¢×œ×” ×’×™×‘×•×™ ×¦'××˜ (.txt) / ×× ×©×™ ×§×©×¨ (.vcf)"),
                  React.createElement('input', {
                    type: "file",
                    id: "whatsappFileInput",
                    accept: ".txt,.vcf",
                    onChange: handleFileSelect,
                    className: "w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer",
                    disabled: loading
                  })
                ),
                React.createElement('div', { className: "flex-grow overflow-y-auto custom-scrollbar" },
                  chatSummaries.map((chat) => (
                    React.createElement('div', {
                      key: chat.id,
                      className: `p-4 border-b border-gray-700 cursor-pointer hover:bg-gray-700 flex items-center space-x-3 space-x-reverse ${currentChatId === chat.id ? 'bg-gray-700' : ''}`,
                      onClick: () => setCurrentChatId(chat.id)
                    },
                      React.createElement('img', {
                        src: contacts.find(c => c.id === chat.contactId)?.profilePic || `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${chat.name.charAt(0)}`,
                        alt: chat.name,
                        className: "w-10 h-10 rounded-full object-cover",
                        onError: (e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${chat.name.charAt(0)}`; }
                      }),
                      React.createElement('div', null,
                        React.createElement('div', { className: "font-semibold text-lg text-green-300" }, chat.name),
                        React.createElement('div', { className: "text-sm text-gray-400 truncate max-w-xs" }, applyHighlighting(chat.summary)),
                        chat.lastMessageTimestamp && (
                          React.createElement('div', { className: "text-xs text-gray-500 mt-1" },
                            (chat.lastMessageTimestamp.toDate ? new Date(chat.lastMessageTimestamp.toDate()) : chat.lastMessageTimestamp).toLocaleDateString('he-IL'), " ", (chat.lastMessageTimestamp.toDate ? new Date(chat.lastMessageTimestamp.toDate()) : chat.lastMessageTimestamp).toLocaleTimeString('he-IL')
                          )
                        )
                      )
                    )
                  ))
                )
              )
            ),

            currentTab === 'contacts' && (
              React.createElement(React.Fragment, null,
                React.createElement('div', { className: "p-4 border-b border-gray-700 flex flex-col gap-2" },
                  React.createElement('input', {
                    type: "text",
                    placeholder: "×—×¤×© ××™×© ×§×©×¨...",
                    className: "w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500",
                    value: contactSearchTerm,
                    onChange: (e) => setContactSearchTerm(e.target.value),
                    dir: "rtl"
                  }),
                  React.createElement('button', {
                    onClick: () => setShowAddContactModal(true),
                    className: "p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center text-sm"
                  },
                    React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 ml-2", viewBox: "0 0 20 20", fill: "currentColor" },
                      React.createElement('path', { fillRule: "evenodd", d: "M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z", clipRule: "evenodd" })
                    ),
                    "×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×©"
                  )
                ),
                React.createElement('div', { className: "flex-grow overflow-y-auto custom-scrollbar p-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-2" },
                  filteredContacts.map((contact) => (
                    React.createElement('div', {
                      key: contact.id,
                      className: "bg-gray-700 p-3 rounded-lg shadow-md flex flex-col items-center text-center cursor-pointer hover:bg-gray-600 transition-colors duration-200 relative group",
                      onClick: () => handleContactClick(contact)
                    },
                      React.createElement('img', {
                        src: contact.profilePic || `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${contact.name.charAt(0)}`,
                        alt: contact.name,
                        className: "w-16 h-16 rounded-full object-cover border-2 border-green-400 mb-2",
                        onError: (e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${contact.name.charAt(0)}`; }
                      }),
                      React.createElement('div', { className: "font-semibold text-md text-green-300" }, contact.name),
                      React.createElement('div', { className: "text-xs text-gray-400" }, contact.whatsappNumber),
                      !chatSummaries.some(chat => chat.contactId === contact.id) && (
                        React.createElement('div', { className: "absolute top-1 right-1 bg-yellow-400 text-gray-900 rounded-full p-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200" }, "â•ï¿½")
                      )
                    )
                  ))
                )
              )
            ),
            React.createElement('div', { className: "p-4 bg-gray-900 text-sm border-t border-gray-700 rounded-b-lg" },
              React.createElement('p', null, "×”××–×”×” ×©×œ×š: ", userId || '×˜×•×¢×Ÿ...')
            )
          ),

          /* Main chat window */
          React.createElement('div', { className: `flex flex-col flex-grow ${isSidebarOpen ? 'md:w-2/3 lg:w-3/4' : 'w-full'} bg-gray-100 rounded-lg shadow-lg m-2` },
            /* Chat header */
            React.createElement('div', { className: "bg-gradient-to-r from-teal-500 to-green-600 text-white p-4 rounded-t-lg shadow-md flex justify-between items-center" },
              React.createElement('div', { className: "flex items-center space-x-3 space-x-reverse" },
                React.createElement('img', {
                  src: currentContactProfilePic,
                  alt: currentChatName,
                  className: "w-10 h-10 rounded-full object-cover border-2 border-white",
                  onError: (e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/A3A9B2/FFFFFF?text=${currentChatName.charAt(0)}`; }
                }),
                React.createElement('h1', { className: "text-xl font-bold" }, currentChatName)
              ),
              React.createElement('button', { onClick: () => setIsSidebarOpen(!isSidebarOpen), className: "md:hidden p-2 rounded-full hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-blue-500" },
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M4 6h16M4 12h16M4 18h16" })
                )
              )
            ),

            /* Message display area */
            React.createElement('div', { className: "flex-grow p-4 overflow-y-auto bg-gray-50 custom-scrollbar relative" },
              messages.length === 0 && (
                React.createElement('p', { className: "text-center text-gray-500 mt-10" },
                  currentChatId ? "×”×¦'××˜ ×”×–×” ×¨×™×§. ×”×ª×—×œ ×©×™×—×”." : "×‘×—×¨ ×¦'××˜ ××”×¦×“, ××• ×”×¢×œ×” ×§×•×‘×¥ ×’×™×‘×•×™ ×©×œ WhatsApp."
                )
              ),
              messages.map((msg) => (
                React.createElement('div', {
                  key: msg.id,
                  className: `flex mb-4 ${msg.sender === myContactName ? 'justify-end' : 'justify-start'}`
                },
                  React.createElement('div', {
                    className: `relative max-w-[80%] px-4 py-2 rounded-lg shadow ${msg.sender === myContactName ? 'bg-green-200 text-right mr-2' : 'bg-white text-left ml-2'}`,
                    onContextMenu: (e) => {
                      e.preventDefault();
                      document.execCommand('copy');
                      setSystemMessage('×”×•×“×¢×” ×”×•×¢×ª×§×” ×œ×œ×•×— (×¡×™××•×œ×¦×™×”).');
                    }
                  },
                    React.createElement('div', { className: "font-bold text-sm mb-1" }, msg.sender === myContactName ? '××ª×”' : msg.sender),
                    React.createElement('p', { className: "text-gray-800", dir: "rtl" }, applyHighlighting(msg.message)),
                    React.createElement('div', { className: "text-xs text-gray-500 mt-1 text-left" },
                      msg.timestamp && (msg.timestamp.toDate ? new Date(msg.timestamp.toDate()) : msg.timestamp).toLocaleTimeString('he-IL')
                    )
                  )
                )
              )),
              React.createElement('div', { ref: messagesEndRef })
            ),

            /* System messages and loading indicator */
            systemMessage && (
              React.createElement('div', { className: "p-2 text-sm text-center bg-blue-100 text-blue-800 border-t border-blue-200" }, systemMessage)
            ),
            loading && (
              React.createElement('div', { className: "p-2 text-sm text-center bg-yellow-100 text-yellow-800 border-t border-yellow-200" }, "×˜×•×¢×Ÿ... ×× × ×”××ª×Ÿ.")
            ),

            /* Message input and action buttons */
            React.createElement('div', { className: "p-4 bg-gray-200 rounded-b-lg shadow-inner flex items-center space-x-2 space-x-reverse" },
              React.createElement('button', {
                onClick: openOrderModal,
                className: "p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200",
                title: "×¦×•×¨ ×”×–×× ×” ×—×“×©×”"
              },
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" })
                )
              ),
              React.createElement('button', {
                onClick: () => openReminderModal(currentChatContact?.contactId),
                className: "p-3 bg-purple-500 text-white rounded-full hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200",
                title: "×¦×•×¨ ×ª×–×›×•×¨×ª ×—×“×©×”"
              },
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" })
                )
              ),
              React.createElement('button', {
                onClick: summarizeChat,
                className: "p-3 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200",
                title: "âœ¨ ×¡×›× ×¦'××˜ ×¢× Gemini",
                disabled: loading || messages.length === 0
              }, "âœ¨ ×¡×›×"),
              React.createElement('button', {
                onClick: draftSmartReminder,
                className: "p-3 bg-pink-500 text-white rounded-full hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-500 transition-colors duration-200",
                title: "âœ¨ ×˜×™×•×˜×ª ×ª×–×›×•×¨×ª ×—×›××” ×¢× Gemini",
                disabled: loading || !inputMessage.trim()
              }, "âœ¨ ×˜×™×•×˜×”"),
              React.createElement('input', {
                type: "text",
                ref: chatInputRef,
                className: "flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200",
                placeholder: "×”×§×œ×“ ×”×•×“×¢×”...",
                value: inputMessage,
                onChange: (e) => setInputMessage(e.target.value),
                onKeyPress: (e) => e.key === 'Enter' && handleSendMessage(),
                onFocus: () => setShowKeyboard(false),
                disabled: loading || !currentChatId,
                dir: "rtl"
              }),
              React.createElement('button', {
                onClick: () => setShowKeyboard(prev => !prev),
                className: "p-3 bg-gray-500 text-white rounded-full hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors duration-200",
                title: "×”×¦×’/×”×¡×ª×¨ ××§×œ×“×ª"
              },
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" })
                )
              ),
              React.createElement('button', {
                onClick: handleSendMessage,
                className: "p-3 bg-green-500 text-white rounded-full hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200",
                disabled: loading || !currentChatId || !inputMessage.trim()
              },
                React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M12 19l9 2-9-18-9 18 9-2zm0 0v-8" })
                )
              )
            ),

            /* Virtual Keyboard */
            React.createElement('div', { className: `transition-all duration-300 ease-in-out transform ${showKeyboard ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0 pointer-events-none'} bg-gray-300 p-4 rounded-b-lg shadow-inner absolute bottom-0 w-full z-10` },
              React.createElement('div', { className: "grid grid-cols-10 gap-1 mb-2" },
                ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ‘', 'â¤ï¸', 'ğŸ™', 'ğŸ”¥', 'ğŸ‰', 'ğŸ¤¯', 'ğŸ‘‹', 'âœ…'].map(emoji => (
                  React.createElement('button', { key: emoji, onClick: () => handleKeyboardInput(emoji), className: "p-2 bg-white rounded-lg hover:bg-gray-100 text-2xl" }, emoji)
                ))
              ),
              React.createElement('div', { className: "grid grid-cols-10 gap-1" },
                ['×§', '×¨', '×', '×˜', '×Ÿ', '×', '×¦', '×‘', '×”', '×’',
                  '×©', '×“', '×œ', '×š', '×£', '×–', '×¡', '×¢', '×™', '×—',
                  '×›', '×¤', '×', '×•', '× ', '×ª', '×¥', '0', '1', '2',
                  '3', '4', '5', '6', '7', '8', '9', ' ', 'â¬…ï¸', '×©×œ×—'].map(key => (
                  React.createElement('button', {
                    key: key,
                    onClick: () => {
                      if (key === 'â¬…ï¸') handleKeyboardDelete();
                      else if (key === '×©×œ×—') handleKeyboardEnter();
                      else handleKeyboardInput(key);
                    },
                    className: `p-2 rounded-lg font-semibold text-gray-800 ${key === ' ' ? 'col-span-4 bg-white' : key === 'â¬…ï¸' ? 'bg-red-300' : key === '×©×œ×—' ? 'bg-green-500 text-white' : 'bg-white hover:bg-gray-100'}`
                  }, key)
                ))
              )
            )
          ),

          /* Order Creation Modal */
          showOrderModal && (
            React.createElement('div', { className: "fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" },
              React.createElement('div', { className: "bg-white rounded-lg p-6 shadow-xl w-full max-w-md relative", dir: "rtl" },
                React.createElement('h2', { className: "text-2xl font-bold mb-4 text-gray-800" }, "×¦×•×¨ ×”×–×× ×” ×—×“×©×”"),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "customerName", className: "block text-gray-700 text-sm font-bold mb-2" }, "×©× ×œ×§×•×—:"),
                  React.createElement('input', {
                    type: "text",
                    id: "customerName",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: orderForm.customer,
                    onChange: (e) => setOrderForm({ ...orderForm, customer: e.target.value }),
                    required: true
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "orderItems", className: "block text-gray-700 text-sm font-bold mb-2" }, "×¤×¨×˜×™ ×”×–×× ×” (×œ×“×•×’××”: ××œ×˜ x10, ×‘×œ×•×§ x50):"),
                  React.createElement('textarea', {
                    id: "orderItems",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24",
                    value: orderForm.items,
                    onChange: (e) => setOrderForm({ ...orderForm, items: e.target.value }),
                    required: true
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "orderDate", className: "block text-gray-700 text-sm font-bold mb-2" }, "×ª××¨×™×š ××¡×¤×§×”:"),
                  React.createElement('input', {
                    type: "date",
                    id: "orderDate",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: orderForm.date,
                    onChange: (e) => setOrderForm({ ...orderForm, date: e.target.value })
                  })
                ),
                React.createElement('div', { className: "mb-6" },
                  React.createElement('label', { htmlFor: "orderNotes", className: "block text-gray-700 text-sm font-bold mb-2" }, "×”×¢×¨×•×ª:"),
                  React.createElement('textarea', {
                    id: "orderNotes",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-20",
                    value: orderForm.notes,
                    onChange: (e) => setOrderForm({ ...orderForm, notes: e.target.value })
                  })
                ),
                React.createElement('div', { className: "flex justify-end space-x-2 space-x-reverse" },
                  React.createElement('button', {
                    onClick: () => setShowOrderModal(false),
                    className: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
                  }, "×‘×™×˜×•×œ"),
                  React.createElement('button', {
                    onClick: handleOrderSubmit,
                    className: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200",
                    disabled: loading
                  }, loading ? '×™×•×¦×¨...' : '×¦×•×¨ ×”×–×× ×”')
                )
              )
            )
          ),

          /* Reminder Creation Modal */
          showReminderModal && (
            React.createElement('div', { className: "fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" },
              React.createElement('div', { className: "bg-white rounded-lg p-6 shadow-xl w-full max-w-md relative", dir: "rtl" },
                React.createElement('h2', { className: "text-2xl font-bold mb-4 text-gray-800" }, "×¦×•×¨ ×ª×–×›×•×¨×ª ×—×“×©×”"),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "reminderTitle", className: "block text-gray-700 text-sm font-bold mb-2" }, "×›×•×ª×¨×ª:"),
                  React.createElement('input', {
                    type: "text",
                    id: "reminderTitle",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: reminderForm.title,
                    onChange: (e) => setReminderForm({ ...reminderForm, title: e.target.value }),
                    required: true
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "reminderDate", className: "block text-gray-700 text-sm font-bold mb-2" }, "×ª××¨×™×š:"),
                  React.createElement('input', {
                    type: "date",
                    id: "reminderDate",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: reminderForm.date,
                    onChange: (e) => setReminderForm({ ...reminderForm, date: e.target.value }),
                    required: true
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "reminderTime", className: "block text-gray-700 text-sm font-bold mb-2" }, "×©×¢×”:"),
                  React.createElement('input', {
                    type: "time",
                    id: "reminderTime",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: reminderForm.time,
                    onChange: (e) => setReminderForm({ ...reminderForm, time: e.target.value }),
                    required: true
                  })
                ),
                React.createElement('div', { className: "mb-6" },
                  React.createElement('label', { htmlFor: "reminderNotes", className: "block text-gray-700 text-sm font-bold mb-2" }, "×”×¢×¨×•×ª:"),
                  React.createElement('textarea', {
                    id: "reminderNotes",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-20",
                    value: reminderForm.notes,
                    onChange: (e) => setReminderForm({ ...reminderForm, notes: e.target.value })
                  })
                ),
                React.createElement('div', { className: "flex justify-end space-x-2 space-x-reverse" },
                  React.createElement('button', {
                    onClick: () => setShowReminderModal(false),
                    className: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
                  }, "×‘×™×˜×•×œ"),
                  React.createElement('button', {
                    onClick: handleReminderSubmit,
                    className: "bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200",
                    disabled: loading
                  }, loading ? '×™×•×¦×¨...' : '×¦×•×¨ ×ª×–×›×•×¨×ª')
                )
              )
            )
          ),

          /* Contact Detail Modal (Internal Page Simulation) */
          showContactDetailModal && selectedContact && (
            React.createElement('div', { className: "fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" },
              React.createElement('div', { className: "bg-white rounded-lg p-6 shadow-xl w-full max-w-2xl relative", dir: "rtl" },
                React.createElement('div', { className: "flex justify-between items-center mb-4 border-b pb-4" },
                  React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, "×¤×¨×˜×™ ××™×© ×§×©×¨: ", selectedContact.name),
                  React.createElement('button', {
                    onClick: () => setShowContactDetailModal(false),
                    className: "p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300"
                  },
                    React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-6 w-6 text-gray-600", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                      React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M6 18L18 6M6 6l12 12" })
                    )
                  )
                ),
                React.createElement('div', { className: "flex items-center space-x-4 space-x-reverse mb-6" },
                  React.createElement('img', {
                    src: selectedContact.profilePic || `https://placehold.co/150x150/A3A9B2/FFFFFF?text=${selectedContact.name.charAt(0)}`,
                    alt: selectedContact.name,
                    className: "w-24 h-24 rounded-full object-cover border-4 border-teal-500",
                    onError: (e) => { e.target.onerror = null; e.target.src = `https://placehold.co/150x150/A3A9B2/FFFFFF?text=${selectedContact.name.charAt(0)}`; }
                  }),
                  React.createElement('div', null,
                    React.createElement('p', { className: "text-xl font-semibold text-gray-800" }, selectedContact.name),
                    React.createElement('p', { className: "text-gray-600" }, selectedContact.whatsappNumber),
                    selectedContact.email && React.createElement('p', { className: "text-gray-600" }, "××™××™×™×œ: ", selectedContact.email),
                    selectedContact.address && React.createElement('p', { className: "text-gray-600" }, "×›×ª×•×‘×ª: ", selectedContact.address),
                    selectedContact.socialMedia && React.createElement('p', { className: "text-gray-600" }, "×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª: ", React.createElement('a', { href: selectedContact.socialMedia, target: "_blank", rel: "noopener noreferrer", className: "text-blue-500 hover:underline" }, selectedContact.socialMedia))
                  )
                ),

                React.createElement('h3', { className: "text-xl font-bold mb-3 text-gray-800" }, "×¤×¢×•×œ×•×ª:"),
                React.createElement('div', { className: "flex flex-wrap gap-3 mb-6" },
                  React.createElement('a', {
                    href: `tel:${selectedContact.whatsappNumber.replace('+', '')}`,
                    className: "p-3 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors duration-200 flex items-center",
                    title: "×—×™×™×’"
                  },
                    React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 ml-2", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2H5a2 2 0 01-2-2z" })),
                    "×—×™×™×’"
                  ),
                  React.createElement('a', {
                    href: `https://wa.me/${selectedContact.whatsappNumber.replace('+', '')}`,
                    target: "_blank",
                    rel: "noopener noreferrer",
                    className: "p-3 bg-whatsapp-green text-white rounded-full hover:bg-whatsapp-dark-green transition-colors duration-200 flex items-center",
                    title: "×©×œ×— ×”×•×“×¢×ª WhatsApp"
                  },
                    React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 ml-2", fill: "currentColor", viewBox: "0 0 16 16" },
                      React.createElement('path', { d: "M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.334.033 7.612v1.748l-.011.026-.007.017-.006.012A12.604 12.604 0 0 0 0 10.366c0 1.261.353 2.251.789 2.876a2.6 2.6 0 0 0 1.442.846l.16.059.168.046c.134.037.266.075.397.108L3 14h2l-1 4h5l-1 4h2l.497 2H10l.497 2h2L12 16h3.601c-.139-.235-.357-.593-.659-1.037-1.125-1.554-1.215-1.928-1.543-2.613L15 13c.123.011.233.023.336.035a6.073 6.073 0 0 0 .614.053c.118-.018.22-.047.306-.089a.784.784 0 0 0 .27-.19.467.467 0 0 0 .11-.271.306.306 0 0 0-.012-.13c-.024-.044-.06-.076-.108-.093a.417.417 0 0 0-.13-.012c-.067.003-.133.012-.197.025a1.862 1.862 0 0 0-.256.05C14.15 12.16 13.601 2.326 13.601 2.326zM7.994 1.452a6.3 6.3 0 0 1 5.922 4.14L13 6H3.34A6.326 6.326 0 0 1 7.994 1.452z"/>
                    ),
                    "×•×•××˜×¡××¤"
                  ),
                  React.createElement('button', {
                    onClick: () => {
                      setShowContactDetailModal(false);
                      openReminderModal(selectedContact.id);
                    },
                    className: "p-3 bg-purple-500 text-white rounded-full hover:bg-purple-600 transition-colors duration-200 flex items-center"
                  },
                    React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 ml-2", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" })),
                    "×¦×•×¨ ×ª×–×›×•×¨×ª"
                  ),
                  React.createElement('button', {
                    onClick: () => {
                      setShowContactDetailModal(false);
                      createOffice365Meeting({ contact: selectedContact.name, date: new Date() });
                    },
                    className: "p-3 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors duration-200 flex items-center"
                  },
                    React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 ml-2", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" })),
                    "×–×™××•×Ÿ ×¤×’×™×©×ª 365"
                  ),
                  React.createElement('button', {
                    onClick: () => {
                      setShowContactDetailModal(false);
                      uploadToGoogleDrive(new File(["dummy content"], "example.txt"), selectedContact.id);
                      setSystemMessage(`×”×¢×œ××ª ×§×•×‘×¥ ×œ-Google Drive ×¢×‘×•×¨ ${selectedContact.name} (×¡×™××•×œ×¦×™×”)...`);
                    },
                    className: "p-3 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors duration-200 flex items-center"
                  },
                    React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 ml-2", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" })),
                    "×”×¢×œ×” ××“×™×” ×œ-Drive"
                  )
                ),

                React.createElement('h3', { className: "text-xl font-bold mb-3 text-gray-800" }, "×”×™×¡×˜×•×¨×™×™×ª ×¦'××˜:"),
                React.createElement('div', { className: "max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50 custom-scrollbar" },
                  chatSummaries.filter(chat => chat.contactId === selectedContact.id).length > 0 ? (
                    messages.filter(msg => chatSummaries.find(chat => chat.id === currentChatId && chat.contactId === selectedContact.id)).map((msg) => (
                      React.createElement('div', { key: msg.id, className: `flex mb-2 ${msg.sender === myContactName ? 'justify-end' : 'justify-start'}` },
                        React.createElement('div', { className: `max-w-[80%] px-3 py-1 rounded-lg shadow-sm text-sm ${msg.sender === myContactName ? 'bg-green-100' : 'bg-gray-100'}` },
                          React.createElement('span', { className: "font-bold" }, msg.sender === myContactName ? '××ª×”' : msg.sender, ": "),
                          applyHighlighting(msg.message),
                          React.createElement('div', { className: "text-xs text-gray-500 mt-1 text-left" },
                            msg.timestamp && (msg.timestamp.toDate ? new Date(msg.timestamp.toDate()) : msg.timestamp).toLocaleTimeString('he-IL')
                          )
                        )
                      )
                    ))
                  ) : (
                    React.createElement('p', { className: "text-center text-gray-500" }, "××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¦\"××˜ ×¢×‘×•×¨ ××™×© ×§×©×¨ ×–×”.")
                  )
                )
              )
            )
          ),

          /* Add New Contact Modal */
          showAddContactModal && (
            React.createElement('div', { className: "fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" },
              React.createElement('div', { className: "bg-white rounded-lg p-6 shadow-xl w-full max-w-md relative", dir: "rtl" },
                React.createElement('h2', { className: "text-2xl font-bold mb-4 text-gray-800" }, "×”×•×¡×£ ××™×© ×§×©×¨ ×—×“×©"),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "newContactName", className: "block text-gray-700 text-sm font-bold mb-2" }, "×©× ××œ×:"),
                  React.createElement('input', {
                    type: "text",
                    id: "newContactName",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: newContactForm.name,
                    onChange: (e) => setNewContactForm({ ...newContactForm, name: e.target.value }),
                    required: true
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "newContactNumber", className: "block text-gray-700 text-sm font-bold mb-2" }, "××¡×¤×¨ ×•×•××˜×¡××¤ (×¢× ×§×™×“×•××ª ×‘×™× ×œ××•××™×ª, ×œ×“×•×’××”: +9725XXXXXXXX):"),
                  React.createElement('input', {
                    type: "text",
                    id: "newContactNumber",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: newContactForm.whatsappNumber,
                    onChange: (e) => setNewContactForm({ ...newContactForm, whatsappNumber: e.target.value })
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "newContactProfilePic", className: "block text-gray-700 text-sm font-bold mb-2" }, "×œ×™× ×§ ×œ×ª××•× ×ª ×¤×¨×•×¤×™×œ:"),
                  React.createElement('input', {
                    type: "text",
                    id: "newContactProfilePic",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: newContactForm.profilePic,
                    onChange: (e) => setNewContactForm({ ...newContactForm, profilePic: e.target.value })
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "newContactEmail", className: "block text-gray-700 text-sm font-bold mb-2" }, "××™××™×™×œ:"),
                  React.createElement('input', {
                    type: "email",
                    id: "newContactEmail",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: newContactForm.email,
                    onChange: (e) => setNewContactForm({ ...newContactForm, email: e.target.value })
                  })
                ),
                React.createElement('div', { className: "mb-4" },
                  React.createElement('label', { htmlFor: "newContactAddress", className: "block text-gray-700 text-sm font-bold mb-2" }, "×›×ª×•×‘×ª:"),
                  React.createElement('input', {
                    type: "text",
                    id: "newContactAddress",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: newContactForm.address,
                    onChange: (e) => setNewContactForm({ ...newContactForm, address: e.target.value })
                  })
                ),
                React.createElement('div', { className: "mb-6" },
                  React.createElement('label', { htmlFor: "newContactSocialMedia", className: "block text-gray-700 text-sm font-bold mb-2" }, "×œ×™× ×§ ×œ×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª:"),
                  React.createElement('input', {
                    type: "text",
                    id: "newContactSocialMedia",
                    className: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",
                    value: newContactForm.socialMedia,
                    onChange: (e) => setNewContactForm({ ...newContactForm, socialMedia: e.target.value })
                  })
                ),
                React.createElement('div', { className: "flex justify-end space-x-2 space-x-reverse" },
                  React.createElement('button', {
                    onClick: () => setShowAddContactModal(false),
                    className: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
                  }, "×‘×™×˜×•×œ"),
                  React.createElement('button', {
                    onClick: handleCreateNewContact,
                    className: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200",
                    disabled: loading
                  }, loading ? '×™×•×¦×¨...' : '×¦×•×¨ ××™×© ×§×©×¨')
                )
              )
            )
          ),

          /* Upload Chat for New Contact Modal */
          showUploadChatModal && selectedContact && (
            React.createElement('div', { className: "fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" },
              React.createElement('div', { className: "bg-white rounded-lg p-6 shadow-xl w-full max-w-md relative", dir: "rtl" },
                React.createElement('h2', { className: "text-2xl font-bold mb-4 text-gray-800" }, "×”×¢×œ×” ×¦'××˜ ×¢×‘×•×¨ ", selectedContact.name),
                React.createElement('p', { className: "mb-4 text-gray-700" }, "×× × ×”×¢×œ×” ×§×•×‘×¥ ×’×™×‘×•×™ ×¦'××˜ (.txt) ×›×“×™ ×œ×™×™×‘× ×”×™×¡×˜×•×¨×™×™×ª ×”×•×“×¢×•×ª ×œ××™×© ×§×©×¨ ×–×”."),
                React.createElement('div', { className: "mb-6" },
                  React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2", htmlFor: "uploadChatFile" }, "×‘×—×¨ ×§×•×‘×¥ ×¦'××˜:"),
                  React.createElement('input', {
                    type: "file",
                    id: "uploadChatFile",
                    accept: ".txt",
                    onChange: (e) => {
                      const file = e.target.files[0];
                      if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                          handleUploadChatForNewContact(event.target.result);
                        };
                        reader.readAsText(file);
                      }
                    },
                    className: "w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-500 file:text-white hover:file:bg-green-600 cursor-pointer",
                    disabled: loading
                  })
                ),
                React.createElement('div', { className: "flex justify-end space-x-2 space-x-reverse" },
                  React.createElement('button', {
                    onClick: () => setShowUploadChatModal(false),
                    className: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200"
                  }, "×‘×™×˜×•×œ")
                )
              )
            )
          )
        )
      );
    };

    // Render the React application
    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App, null));

  </script>
</head>
<body class="bg-gray-900 overflow-hidden">
  <div id="root"></div>
</body>
</html>
ï¿½
